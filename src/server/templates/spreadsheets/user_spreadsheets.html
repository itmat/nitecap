{% extends "base.html" %}
{% block content %}

<script>

    $(function () {
        $('[data-toggle="tooltip"]').tooltip()
    });

    $(document).ready(function() {

         let show_button = $("#show-button");
         show_button.prop('disabled', true);
         let compare_button = $("#compare-button");
         compare_button.prop('disabled', true);
         let delete_button = $("#delete-button");
         delete_button.prop('disabled', true);

        {#  raw/endraw needed to make jinga ignore this code.  This is a Mustache template. #}
        {% raw %}
        var template = "<div id='spreadsheet_notes_{{ spreadsheet_id }}' class='annotate_form'>\n" +
            "             <textarea data-id='{{ spreadsheet_id }}' class='form-control' cols='30' rows='10'>{{ note }}</textarea>\n" +
            "              <div class='float-right'>\n" +
            "                <button class='btn-annotate btn btn-primary'>\n" +
            "                  <i class='fas fa-check'></i>\n" +
            "                </button>\n" +
            "                <button class='btn-annotate-dismiss btn btn-white'>\n" +
            "                  <i class='fas fa-times'></i>\n" +
            "                </button>\n" +
            "              </div>\n" +
            "            </div>";
        {% endraw %}

        // Note popover for each spreadsheet
        let popovers = $('.annotate_spreadsheet[data-toggle="popover"]');

        // When the popover is shown (i.e., when the note icon is clicked)
        popovers.popover().on('shown.bs.popover', function() {

            // When the check button is clicked inside the open note popover - when the user elects to save the note.
            $('.btn-annotate').on('click', function() {

                // Locate the spreadsheet id and the note content
                let parentElement = $(this).parent().parent();
                let textareaElement = parentElement.find('textarea');
                let spreadsheet_id = textareaElement.attr("data-id");
                let note = textareaElement.val();

                // Find the specific anchor tag that calls the popover
                let anchorElement = $('a.annotate_spreadsheet[data-id="' + spreadsheet_id + '"]');

                // Send the data back to the server for saving.
                $.ajax({
                    url: "{{url_for('spreadsheets.save_note')}}",
                    data: JSON.stringify({"spreadsheet_id": spreadsheet_id, "note": note}),
                    dataType: "json",
                    contentType: "application/json",
                    type: 'POST',
                    success: function () {

                        // Add the new note content to the anchor tag that called the popover so that the
                        // user will see the new content if s/he opens the note for editing again.
                        let new_data = {"spreadsheet_id": spreadsheet_id, "note": note};
                        let new_content = '"' + Mustache.to_html(template, new_data) + '"';
                        anchorElement.attr('data-content', new_content);
                    },
                    error: function (request) {

                        // Inject the error message returned by the server into the error modal and display it.
                        let error_message = $.parseJSON(request.responseText).error;
                        nitecap_error_message.text(error_message);
                        nitecap_error.modal();
                    },
                    complete: function() {

                        // Regardless of outcome, hide the popover
                        popovers.popover('hide');
                    }
                });
            });

            // When the x button is clicked inside the open note popover - the user is dismissing the popover without
            // saving any new edits.
            $('.btn-annotate-dismiss').on('click', function() {
                popovers.popover('hide');
            });
        });

        // Note that these elements exist on the base.html page because they are commonly used.
        let nitecap_error = $("#error-modal");
        let nitecap_error_message = $("#error-modal-message");

        let spreadsheetTableElement = $('#spreadsheetTable');

        // Data table - initial sort on spreadsheet install date descending.  ID column is hidden.  Actions
        // column is not subject to sorting.  Multiple columns can be selected.
        let table = spreadsheetTableElement.DataTable({
                        aoColumnDefs: [
                            { 'bSortable': false, 'aTargets': [ 8 ] },
                            { 'visible': false, 'aTargets': [8] },
                            {
                                orderable: false,
                                className: 'select-checkbox',
                                targets:   0
                            }
                        ],
                        order: [[ 2, 'desc' ]],
                        select: {
                            style:    'multi+shift',
                            selector: 'td:first-child'
                        }
                    });

        // Prevents user selection of any spreadsheet rows indicated as in error (we have had an experience with
        // file corruption)
        table.on('user-select', function(e, dt, type, cell, originalEvent) {
            let tr = $(originalEvent.target).parent();
            if(!tr.hasClass('text-dark')) {
                e.preventDefault();
            }
        });

        // Enable/disable Compare and Delete buttons according to the number of rows selected.
        function setButtons() {
            let number_rows_selected = table.rows({selected: true}).count();
            console.log("Number rows: " + number_rows_selected);
            switch(number_rows_selected) {
                case 0:
                    show_button.prop('disabled', true);
                    compare_button.prop('disabled', true);
                    delete_button.prop('disabled', true);
                    break;

                case 1:
                    show_button.prop('disabled', false);
                    compare_button.prop('disabled', true);
                    delete_button.prop('disabled', false);
                    break;
                case 2:
                    show_button.prop('disabled', true);
                    compare_button.prop('disabled', false);
                    delete_button.prop('disabled', false);
                    break;
                default:
                    show_button.prop('disabled', true);
                    compare_button.prop('disabled', true);
                    delete_button.prop('disabled', false);
            }
        }
        table.on('select', setButtons);
        table.on('deselect', setButtons);

        // Using the pencil icon to identify the lone inline editable column.
        let inline_edit = '\n' +
            '              <div class="float-right text-primary">\n' +
            '                <i class="fas fa-pencil-alt"></i>\n' +
            '              </div>\n';


        // When the user clicks on a cell with a pencil icon, we provide and inline input field and allow the user
        // to change the spreadsheet name in line.
        spreadsheetTableElement.on('click','.rename_spreadsheet', function(event) {
            let cell = $(event.target);
            if(!cell.hasClass("rename_spreadsheet")) {
                cell = cell.parents("td > div")
            }

            // Remove the rename spreadsheet class to avoid calling this function while the user clicks inside the
            // cell.
            cell.removeClass('rename_spreadsheet');
            let current_name = cell.text().trim();
            let input_form = "<input type='text' value='" + current_name + "' />" +
                "             <div class='float-right'>\n" +
                "               <button class='btn-rename btn btn-primary'>\n" +
                "                 <i class='fas fa-check'></i>\n" +
                "               </button>\n" +
                "               <button class='btn-rename-dismiss btn btn-white'>\n" +
                "                 <i class='fas fa-times'></i>\n" +
                "               </button>\n" +
                "             </div>\n";
            cell.html(input_form);
        });

        // If the user aborts an inline edit, we return the original spreadsheet name and add the pencil icon back.
        // Put the rename_spreadsheet class back so that the listener will work again.
        spreadsheetTableElement.on('click', '.btn-rename-dismiss', function(event) {
            event.stopPropagation();
            let cell = $(event.target).parents("td > div");
            let current_name = cell.data("name");
            cell.addClass('rename_spreadsheet');
            cell.html(current_name + inline_edit);
        });

        // When the user submits an inline edit, we issue an ajax call with the new name for this spreadsheet and
        // update the prior name with the new name if one is returned from the ajax cell.  Otherwise, the prior name
        // is kept.  Again the rename_spreadsheet class is put back so that the listener will work again.
        spreadsheetTableElement.on('click', '.btn-rename', function(event) {
            event.stopPropagation();
            let cell = $(event.target).parents("td > div");
            console.log(cell);
            let new_name = cell.find("input").val();
            $.ajax({
                url: "{{url_for('spreadsheets.rename')}}",
                data: JSON.stringify({'spreadsheet_id': cell.data("id"), 'name': new_name}),
                dataType: "json",
                contentType: "application/json",
                type: 'POST',
                success: function (response) {
                    new_name = response['name'];
                    cell.data("name", new_name);
                    cell.html(new_name + inline_edit);
                },
                error: function (request) {

                    cell.html(cell.data("name") + inline_edit);

                    // Inject the error message returned by the server into the error modal and display it.
                    let error_message = $.parseJSON(request.responseText).error;
                    nitecap_error_message.text(error_message);
                    nitecap_error.modal();
                },
                complete: function() {
                    cell.addClass('rename_spreadsheet');
                }
            });
        });


        // User clicks the share icon
        spreadsheetTableElement.on('click','.share_spreadsheet', function(event) {

            // Locate the id of the spreadsheet to share
            let spreadsheet_id = $(event.target).parent().attr('id').split("_")[2];

            // Call the server with the spreadsheet id so that the server may return a link that can be shared.
            $.ajax({
                url: "{{url_for('spreadsheets.share')}}",
                data: JSON.stringify({'spreadsheet_ids': [spreadsheet_id]}),
                dataType: "json",
                contentType: "application/json",
                type: 'POST',
                success: function (response) {

                    // Display a modal containing the share link
                    let url = "{{url_for('spreadsheets.share', _external=True)}}/" + response['share'];
                    $("#share_url").val(url);
                    $('#share_popup').modal()
                },
                error: function (request) {

                    // Inject the error message returned by the server into the error modal and display it.
                    let error_message = $.parseJSON(request.responseText).error;
                    nitecap_error_message.text(error_message);
                    nitecap_error.modal();
                }
            });
        });

        let delete_confirmed_button = $("#delete_confirmed");
        let confirm_delete_message = $("#confirm_delete_message");
        let confirm_delete_modal = $("#confirm_delete_modal");

        spreadsheetTableElement.on('click', '.delete_spreadsheet' , function() {
            delete_confirmed_button.attr('data-id', $(this).attr('data-id'));
            delete_confirmed_button.attr('data-source', 'icon');
            confirm_delete_message.text("Please confirm deletion...");
            confirm_delete_modal.modal();
        });


        // Button to show a spreadsheet
        show_button.click(function() {
            let row_data = table.row( {selected:true} ).nodes();
            let spreadsheet_ids = [];
            $.map($(row_data), function(item) {
                spreadsheet_ids.push($(item).data("id"))
            });
            console.log(spreadsheet_ids);

            if (spreadsheet_ids.length !== 1) {
                let error_message = "Can only show one spreadsheet at a time";
                nitecap_error_message.text(error_message);
                nitecap_error.modal();
                return;
            }

            // Disable the compare button and display the spinner
            compare_button.prop('disabled', true);
            compare_button.html("" +
                "<span class='spinner-border spinner-border-sm text-light mr-2' role='status' aria-hidden='true'>" +
                "</span>Processing...");

            // Go to show_spreadsheet page for the selected spreadsheet
            // Frustrantingly, the url_for() function is run on the server but requires the spreadsheet_id argument
            // which is not known until run-time, hence we have to just give it a dummy-value and then replace as necessary
            let target_url = "{{ url_for('spreadsheets.show_spreadsheet',spreadsheet_id='999')}}";
            window.location.href = target_url.replace('999', '' + spreadsheet_ids[0]);
        });

        // Insure compare button initially labeled properly.
        compare_button.html('Compare');

        // Launch comparison
        compare_button.click(function() {

            // Extract the spreadsheet ids from the selected rows.
            let row_data = table.rows( { selected: true } ).nodes();
            let spreadsheet_ids = [];
            $.map($(row_data), function(item) {
                spreadsheet_ids.push($(item).data("id"))
            });

            // Insure that only 2 rows are selected.  For now we can only compare 2 spreadsheets.  Display
            // error modal otherwise.
            if(!spreadsheet_ids || spreadsheet_ids.length !== 2) {
                let error_message = "Presently, we only support comparing two spreadsheets at a time.  " +
                                    "Please adjust your selection accordingly.";
                nitecap_error_message.text(error_message);
                nitecap_error.modal();
            }
            else {

                // Disable the compare button and display the spinner
                compare_button.prop('disabled', true);
                compare_button.html("" +
                    "<span class='spinner-border spinner-border-sm text-light mr-2' role='status' aria-hidden='true'>" +
                    "</span>Processing...");

                // Call the flask compare function and pass the spreadsheet ids as a query string.
                let target_url = "{{ url_for('spreadsheets.show_spreadsheet',spreadsheet_id='999')}}";
                window.location.href = target_url.replace('999', '' + spreadsheet_ids.join(','));
            }
        });

        delete_button.on('click', function() {

             // Extract the spreadsheet ids from the selected rows.
            let row_data = table.rows( { selected: true } ).nodes();
            let spreadsheet_ids = [];
            $.map(row_data, function(item) {
                spreadsheet_ids.push($(item).data("id"));
            });
            delete_confirmed_button.attr('data-id', spreadsheet_ids.join(','));
            delete_confirmed_button.attr('data-source', 'button');
            confirm_delete_message.text("Please confirm deletion of " + spreadsheet_ids.length + " items...");
            confirm_delete_modal.modal();
        });

        // Delete is confirmed - send AJAX call to delete spreadsheet
        delete_confirmed_button.on('click', function() {
            console.log($(this).data("source"));
            if($(this).data("source") === 'icon') {
                let spreadsheet_id = $(this).attr('data-id');
                confirm_delete_modal.modal('toggle');
                $.ajax({
                    url: "{{url_for('spreadsheets.delete')}}",
                    data: JSON.stringify({"spreadsheet_id": spreadsheet_id}),
                    dataType: "json",
                    contentType: "application/json",
                    type: 'POST',
                    success: function () {

                        // The parameter in draw is needed to keep the user on the current page
                        table.row("#spreadsheet_" + spreadsheet_id).remove().draw(false);
                    },
                    error: function (request) {
                        let error_message = $.parseJSON(request.responseText).error;
                        nitecap_error_message.text(error_message);
                        nitecap_error.modal();
                    }
                });
            }
            else if($(this).data("source") === "button") {
                let spreadsheet_ids = $(this).attr('data-id');
                console.log(spreadsheet_ids);
                confirm_delete_modal.modal('toggle');
                $.ajax({
                    url: "{{url_for('spreadsheets.bulk_delete')}}",
                    data: JSON.stringify({"spreadsheet_ids": spreadsheet_ids.split(",")}),
                    dataType: "json",
                    contentType: "application/json",
                    type: 'POST',
                    success: function (response) {

                        console.log(response['spreadsheet_removed_ids']);

                        // The parameter in draw is needed to keep the user on the current page
                        for(spreadsheet_id of response['spreadsheet_removed_ids']) {
                            console.log(spreadsheet_id);
                            table.row("#spreadsheet_" + spreadsheet_id).remove().draw(false);
                        }
                    },
                    error: function (request) {
                        let error_message = $.parseJSON(request.responseText).error;
                        nitecap_error_message.text(error_message);
                        nitecap_error.modal();
                    }
                });
            }
        });
    });

</script>

<div class="page-header">
    <h1>Saved Spreadsheets</h1>
</div>

{% with messages = get_flashed_messages() %}
    {% if messages %}
        <div class="badge badge-info">Notes</div>
        <div class="server-notes">
            {% for message in messages %}
                <div>{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

{% if errors %}
    <div id="error-indicator" class="badge badge-danger">Errors</div>
    <div class="server-errors">
        {% for error in errors %}
            <div>{{error}}</div>
        {% endfor %}
    </div>
{% endif %}

{% if user.spreadsheets %}
    <table id="spreadsheetTable" class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>
                </th>
                <th>Uploaded File</th>
                <th>Date Installed</th>
                <th>Name</th>
                <th>Cycle<br>length</th>
                <th>Time-<br />points</th>
                <th>Last Update</th>
                <th>Actions</th>
                <th>ID</th>
            </tr>
        </thead>
        <tbody>
        {% for spreadsheet in user.spreadsheets %}
            {% if spreadsheet.error %}
                {% set class="alert alert_danger" %}
            {% else %}
                {% set class="text-dark" %}
            {% endif %}
            <tr class={{class}} id="spreadsheet_{{spreadsheet.id}}" data-id="{{ spreadsheet.id }}">
                <td></td>
                <td>{{spreadsheet.original_filename}}</td>
                <td data-sort="{{spreadsheet.date_uploaded}}">
                    {{ momentjs(spreadsheet.date_uploaded).format('LLL') }}
                </td>
                <td>
                    <div data-id="{{ spreadsheet.id }}" data-name="{{ spreadsheet.descriptive_name }}"
                         class="rename_spreadsheet" style="cursor:pointer">
                        {{spreadsheet.descriptive_name}}
                        <div class="float-right text-primary"><i class="fas fa-pencil-alt"></i></div>
                    </div>
                </td>
                <td>{{spreadsheet.timepoints}}</td>
                <td>{{spreadsheet.num_timepoints}}</td>
                <td data-sort="{{spreadsheet.last_access}}">
                    {{ momentjs(spreadsheet.last_access).format('LLL') }}
                </td>
                <td class="actions">
                     <a href="{{ url_for('spreadsheets.collect_data', spreadsheet_id = spreadsheet.id) }}">
                        <i class="fas fa-edit" data-toggle="tooltip" data-placement="top" title="Edit"></i>
                    </a>
                    <a href="{{ url_for('spreadsheets.show_spreadsheet', spreadsheet_id = spreadsheet.id) }}">
                        <i class="fas fa-eye" data-toggle="tooltip" data-placement="top" title="View graphs"></i>
                    </a>
                    <a id='share_spreadsheet_{{spreadsheet.id}}' class="share_spreadsheet text-primary">
                       <i class="fas fa-share-square" data-toggle="tooltip" data-placement="top" title="Share"></i>
                    </a>
                    <a data-id="{{ spreadsheet.id }}" class="delete_spreadsheet text-primary">
                        <i class="fas fa-trash" data-toggle="tooltip" data-placement="top" title="Delete"></i>
                    </a>
                    <a data-id="{{ spreadsheet.id }}" class="annotate_spreadsheet text-primary" rel="popover"
                       data-container="body" data-toggle="popover" data-placement="left" data-trigger="click"
                       title="Add a Note" data-html=true
                       data-content="<div id='spreadsheet_notes_{{ spreadsheet.id }}' class='annotate_form'>
                                       <textarea data-id='{{ spreadsheet.id }}' class='form-control' cols='30' rows='10'>{{ spreadsheet.note or '' }}</textarea>
                                       <div class='float-right'>
                                         <button class='btn-annotate btn btn-primary'>
                                           <i class='fas fa-check'></i>
                                         </button>
                                         <button class='btn-annotate-dismiss btn btn-white'>
                                           <i class='fas fa-times'></i>
                                         </button>
                                       </div>
                                     </div>"
                    >
                        <i class="fas fa-sticky-note" data-toggle="tooltip" data-placement="top" title="Annotate"></i>
                    </a>
                </td>
                <td>{{spreadsheet.id}}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <button type="button" class="btn btn-primary selectedSignle" id="show-button">Show</button>
    <button type="button" class="btn btn-primary" id="compare-button">Compare</button>
    <button type="button" class="btn btn-primary" id="delete-button">
        Delete
        <i class="fas fa-trash"></i>
    </button>
{% endif %}


<div id="share_popup" class="modal fade" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header bg-primary">
        <h5 class="modal-title text-white">SHARE this spreadsheet</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span class="text-white" aria-hidden="true">&times;</span>
        </button>
      </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="share_url">Copy this URL and offer it to anyone with whom you'd like to share your
                    spreadsheet data:</label>
                <textarea id="share_url" class="form-control" rows="5"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
    </div>
  </div>
</div>

<div class="modal fade" id="confirm_delete_modal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-primary">
                <h5 class="model-title text-white">DELETE Confirmation</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span class="text-white" aria-hidden="true">&times;</span>
                </button>
            </div>
            <div id="confirm_delete_message" class="modal-body">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">Cancel</span>
                </button>
                <a id="delete_confirmed" class="btn btn-primary">
                    <span class="text-white">Delete</span>
                </a>
            </div>
        </div>
    </div>
</div>

{% endblock %}

<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  </head>
  <body>
    <div id="app">
      <h3>Spreadsheet: {{ spreadsheet.filename }}</h3>

      <p>Run analyses:</p>
      <ol>
        <li v-for="algorithm in algorithms">
          <button @click="runAnalysis(algorithm)">{{ algorithm }}</button>
        </li>
      </ol>

      <p>Analyses:</p>
      <ul>
        <li v-for="analysis in analyses">
          <div v-if="analysis.status === 'PENDING'">
            Analysis {{ analysis.algorithm }} is pending...
          </div>
          <div v-if="analysis.status === 'RUNNING'">
            Analysis {{ analysis.algorithm }} is running:
            <progress
              :value="analysis.progress.value"
              :max="analysis.progress.max"
            />
          </div>
          <div v-if="analysis.status === 'FINALIZING'">
            Analysis {{ analysis.algorithm }} is being finalized...
            <progress value="" max="" />
          </div>
          <div v-if="analysis.status === 'COMPLETED'">
            Analysis {{ analysis.algorithm }}
            <span v-if="analysis.duration"
              >completed in {{ analysis.duration }} ms.</span
            >
            <span v-if="!analysis.duration">is complete.</span>
          </div>
        </li>
      </ul>

      <p>Results:</p>
      <ul>
        <li v-for="(result, analysisId) in results">
          p values of the first few features for {{
          analyses[analysisId].algorithm }} analysis:
          <div v-for="value in result.p.slice(0, 10)">{{ value }}</div>
        </li>
      </ul>
    </div>

    <script>
      let app = new Vue({
        el: "#app",
        data: {
          analyses: {},
          results: {},
          notificationApiConnection: null,
          ...DATA,
        },
        methods: {
          runAnalysis: async function (algorithm) {
            let spreadsheetId = this.spreadsheet.id;

            let response = await fetch("/analysis", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ algorithm, spreadsheetId }),
            });

            let analysisId = await response.text();

            // // Check analysis id
            // let parameters = JSON.stringify({
            //   algorithm,
            //   spreadsheetId,
            //   userId: this.userId,
            // });

            // if (analysisId !== (await sha256(parameters)))
            //   console.error("Mismatch in analysis ID calculation");

            Vue.set(this.analyses, analysisId, {
              algorithm,
              spreadsheetId,
              status: "PENDING",
              startTime: performance.now(),
              progress: null,
              duration: 0,
            });

            this.connectToNotificationApi();
          },

          connectToNotificationApi: function () {
            if (this.notificationApiConnection) return;

            this.notificationApiConnection = new WebSocket(
              this.NOTIFICATION_API_ENDPOINT
            );

            this.notificationApiConnection.onopen = () =>
              this.notificationApiConnection.send(this.userId);

            this.notificationApiConnection.onerror = (event) =>
              console.log(
                "An error in communication with notification API has occurred:",
                event
              );

            this.notificationApiConnection.onclose = () => {
              this.notificationApiConnection = null;
              console.log("Connection with notification API closed");
            };

            this.notificationApiConnection.onmessage = this.processNotification;
          },

          processNotification: async function (event) {
            message = JSON.parse(event.data);

            let { analysisId, ...analysisUpdate } = message;
            let analysis = this.analyses[analysisId];

            // There are several explanations for the situation when the analysis is not in our analyses collection:
            //  - the user might have refreshed the page
            //  - this update is for analysis of another spreadsheet
            //
            // Let's first fetch the information about the missing analysis:
            if (!analysis) {
              let response = await fetch(`/analysis/${analysisId}/parameters`);
              analysis = await response.json();
            }

            // Skip if this update is for analysis of another spreadsheet
            if (analysis.spreadsheetId !== this.spreadsheet.id) return;

            analysis["duration"] = performance.now() - analysis.startTime; // the start time information is lost upon refresh

            Vue.set(this.analyses, analysisId, {
              ...analysis,
              ...analysisUpdate,
            });

            if (analysisUpdate["status"] === "COMPLETED")
              this.fetchResults(analysisId);
          },

          fetchResults: async function (analysisId) {
            let response = await fetch(`/analysis/${analysisId}/results`);
            let results = await response.json();
            Vue.set(this.results, analysisId, results);
          },
        },
        mounted() {
          this.connectToNotificationApi();
        },
        beforeUnmount() {
          this.notificationApiConnection.close(1001);
        },
      });

      async function sha256(message) {
        let messageBuffer = new TextEncoder("utf-8").encode(message);
        let hashBuffer = await window.crypto.subtle.digest(
          "sha-256",
          messageBuffer
        );
        let hashArray = Array.from(new Uint8Array(hashBuffer));
        let hash = hashArray
          .map((byte) => ("00" + byte.toString(16)).slice(-2))
          .join("");

        return hash;
      }
    </script>
  </body>
</html>

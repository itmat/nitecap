{% extends "base.html" %}
{% block content %}

<script>
    var column_label_formats = [
                new RegExp("CT(\\d+)"), new RegExp("ct(\\d)"),
                new RegExp("(\\d+)CT"), new RegExp("(\\d)ct"),
                new RegExp("ZT(\\d+)"), new RegExp("zt(\\d+)"),
                new RegExp("(\\d+)ZT"), new RegExp("(\\d+)zt")
    ];
    function guessColumnLabels(columns, days, timepoints) {
        let best_num_matches = 0;
        let best_matches = [];

        column_label_formats.forEach( function(fmt) {
            let matches = columns.map( function(label) { return fmt.exec(label); } );
            let num_matches = matches.filter( function(match) { return match !== null; }).length;
            if (num_matches > best_num_matches) {
                best_num_matches = num_matches;
                best_matches = matches;
            }
        });

        if (best_num_matches > 0) {
            let times = best_matches.map( function(match) {
                if (match !== null) {
                    return parseInt(match[1], 10);
                } else {
                    return null;
                }
            } );
            let selected_columns = columns.map(function(column, i) {
                let match = best_matches[i];
                if (match !== null) {
                    return column
                } else {
                    return null;
                }
            });

            let min_time = Math.min.apply(null, times.filter(function(t) {return t !== null;}));
            let max_time = Math.max.apply(null, times.filter(function(t) {return t !== null;}));
            let total_time_delta = max_time - min_time;
            let time_per_timepoint = total_time_delta / (timepoints * days - 1);

            let time_point_counts = times.map(function(time,i) {
                let match = best_matches[i];
                if (match !== null) {
                    return (time - min_time) / time_per_timepoint;
                } else {
                    return null;
                }
            });

            if (time_point_counts.every(function(t) {if (t !== null) {return Number.isInteger(t)} return true;})) {
                let selections = time_point_counts.map( function(time_point_count, i) {
                    if (time_point_count === null) {
                        if (i == 0) {
                            return "ID";
                        } else {
                            return "Ignore";
                        }
                    }
                    return "Day" + (Math.floor(time_point_count / timepoints) + 1) + " Timepoint" + (time_point_count % timepoints + 1);
                });

                return selections;
            }

            // Okay, so the timepoitns aren't evenly distributed
            // But let's check there might be the right number of them
            // assuming that there are constant number of reps per day
            // and that they are in the right order
            if (best_num_matches % (timepoints*days) === 0) {
                let num_reps = Math.floor(best_num_matches / timepoints*days);

                let selections = [];
                let selected_below = 0;
                columns.map( function(column, i) {
                    if (best_matches[i] !== null) {
                        day = Math.floor(selected_below / timepoints);
                        time = selected_below % timepoints;
                        selections[i] = "Day" + (day+1) + " Timepoint" + (time+1);
                        selected_below += 1;
                    } else {
                        if (i == 0) {
                            selections[i] = "ID";
                        } else {
                            selections[i] = "Ignore";
                        }
                    }
                });
                return selections;
            }

            // No selections, we have uneven timepoints
            return columns.map( function(x) {return "Ignore";} );
        } else {
            return columns.map( function(x) {return "Ignore";} );
        }
    };

    function getLabelOptions(days, timepoints) {
        let options = ["Ignore", "ID"];
        for(let i = 0; i < days; i++) {
            for(let j = 0; j < timepoints; j++) {
                options.push("Day" + (i+1) + " Timepoint" + (j+1));
            }
        }
        return options;
    };

    $(document).ready ( function() {

        columns = {{ (spreadsheet.df.columns.tolist()) | safe }};

        {% if not spreadsheet.days or not spreadsheet.timepoints %}
            $("#selectors").css("visibility", "hidden");
        {%  else %}
            $("#selectors").css("visibility", "visible");
        {%  endif %}

        // List of elements
        let nitecap_form = $('form');
        let nitecap_table = $('form table');
        let submit_button = $("form button");
        let nitecap_error = $("#error-modal");
        let nitecap_error_message = $("#error-modal-message");

        // Set up scrollbars for top and bottom
        $('.topScroll > div').width(nitecap_table.width());
        $('.bottomScroll > div').width(nitecap_table.width());

        $(".topScroll").scroll( function() {
            $(".bottomScroll").scrollLeft($(".topScroll").scrollLeft());
        });
        $(".bottomScroll").scroll( function() {
            $(".topScroll").scrollLeft($(".bottomScroll").scrollLeft());
        });

        // Insure same starting state
        submit_button.prop('disabled', false);
        submit_button.html('Submit');
        nitecap_error_message.text("");


        let days = $("#days");
        let timepoints = $("#timepoints");

        function updateLabels() {
            let guessed_labels = guessColumnLabels(columns, days.val(), timepoints.val());
            let options = getLabelOptions(days.val(), timepoints.val());

            populate_selects(options, guessed_labels);
        }

        function populate_selects(options, defaults) {
            $("#selectors").css("visibility", "visible");
            $("select").each(function (index) {
                $(this).empty();
                let that = $(this);
                let selected = defaults[index];
                console.log(selected, options);
                options.forEach(function (option, option_index) {
                    $(that).append(
                        $("<option>").attr('value', option)
                            .attr('selected', selected === option)
                            .text(option)
                    );
                });
            });
        }

        days.on('change', updateLabels);
        timepoints.on('change', updateLabels);


        // Form Submitted
        nitecap_form.on('submit', function (e) {
            e.preventDefault();

            // Build the parameter list for the AJAX call.
            let spreadsheet_id = {{ spreadsheet.id }};
            let id_columns = [];
            let data = nitecap_form.serialize().split('&');
            data.forEach(function(item) {
                let results = item.split("=");
                if(results[1] === "ID") {
                    id_columns.push(parseInt(results[0].substring(3)) - 1)
                }
            });

            // If no ID columns are selected.  Stop the submit and notify the user.
            if($.isEmptyObject(id_columns)) {
                nitecap_error_message.text("You must select at least one ID column.");
                nitecap_error.modal();
            }
            else {
                // Otherwise check the id combined id columns for duplicates
                $.ajax({
                    url: "{{ url_for('spreadsheets.check_id_uniqueness') }}",
                    data: JSON.stringify({'spreadsheet_id': spreadsheet_id, 'id_columns': id_columns}),
                    dataType: "json",
                    contentType: "application/json",
                    type: 'POST',
                    // Notify the user of any non-unique ids and then submit the form once the user acknowledges.
                    success: function (response) {
                        let non_unique_ids = response['non-unique_ids'];
                        if (non_unique_ids && non_unique_ids.length > 0) {
                            let warning = "The IDs listed here are non-unique and as such, will be excluded from any comparison studies: ";
                            if (non_unique_ids.length > 5) {
                                warning += non_unique_ids.slice(0, 5).join(', ');
                                warning += ", ... and " + (non_unique_ids.length - 5) + " other";
                                warning += non_unique_ids.length - 5 > 1 ? "s." : "."
                            } else {
                                warning += non_unique_ids.join(',');
                            }
                            alert(warning);
                        }

                        // Only when form is about to be submitted should the submit button is disabled
                        submit_button.prop('disabled', true);
                        submit_button.html("<span class='spinner-border spinner-border-sm text-light mr-2' " +
                                           "role='status' aria-hidden='true'></span>Loading...");
                        e.currentTarget.submit();
                    },
                    // If an error is returned notify the user.
                    error: function (request) {
                        error_message = $.parseJSON(request.responseText).error;
                        nitecap_error_message.text(error_message);
                        nitecap_error.modal();
                    }
                });
            }
        });
    });
</script>

<div class="page-header">
    <h1>
        Collect Data
        <small>Indicate additional spreadsheet metadata including which days/timepoints to use</small>
    </h1>
</div>


{% with messages = get_flashed_messages() %}
    {% if messages %}
        <div class="badge badge-info">Notes</div>
        <div class="server-notes">
            {% for message in messages %}
                <div>{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

{% if errors %}
    <div class="badge badge-danger">Errors</div>
    <div class="server-errors">
        {% for error in errors %}
            <div>{{error}}</div>
        {% endfor %}
    </div>
{% endif %}

<form method="post" action="{{ url_for('spreadsheets.collect_data', spreadsheet_id = spreadsheet.id) }}">
    <div class="form-group">
        <label for="descriptive_name">Enter Descriptive Name for the Spreadsheet Data:</label>
        <input type="text" id="descriptive_name" name="descriptive_name" class="form-control"
               value="{{spreadsheet.descriptive_name or ''}}" style="width:40rem" maxlength="250" />
    </div>
    <div class="form-group">
        <label for="days">Enter Number of Days of Data:</label>
        <input type="number" id="days" name="days" class="form-control" style="width:15rem"
               value="{{spreadsheet.days or ''}}" required />
    </div>
    <div class="form-group">
        <label for="timepoints">Enter the Number of Timepoints Per Day:</label>
        <input type="number" id="timepoints" name="timepoints" class="form-control" style="width:15rem"
               value="{{spreadsheet.timepoints or ''}}" required />
    </div>
    <div class="form-group">
        Repeated Measures?
        <label class="radio-inline">
            <input type="radio" id="repeated_measures_yes" name="repeated_measures" value="y"> Yes
        </label>
        <label class="radio-inline">
            <input type="radio" id="repeated_measures_no" name="repeated_measures" value="n" checked> No
        </label>
    </div>
    <div class="form-group">
        <label for="header_row">The Spreadsheet Header is on Row:</label>
        <input type="number" id="header_row" name="header_row" class="form-control" value="{{spreadsheet.header_row or 1}}"
               style="width:15rem" required />
    </div>
    <p>
        Shown are the first 10 rows of your data. Please indicate those columns that represent ids and timepoints.
        Use the same label from the droplist for each replicate. All columns not representing timepoints
        or ids should be set to 'Ignore'.
    </p>
    <div class="topScroll">
        <div></div>
    </div>
    <div class="bottomScroll">
        <div>
            <table class="table table-striped table-bordered table-sm">
                <tr>
                    {% for heading in spreadsheet.df.columns %}
                    <th>{{ heading }}</th>
                    {% endfor %}
                </tr>
                <tr id="selectors" style="visibility: {{ 'visible' if days and timepoints else 'hidden' }}">
                    {% for heading, default_selection in spreadsheet.column_defaults() %}
                    <th>
                            <select style="font-size: 10px" name="col{{ loop.index }}" id="col{{ loop.index }}">
                                {% for selection in spreadsheet.get_selection_options() %}
                                    <option value="{{selection}}"
                                        {{'selected' if selection == default_selection else ''}} > {{selection}}
                                    </option>
                                {% endfor %}
                            </select>
                    </th>
                    {% endfor %}
                </tr>
                {% for record in spreadsheet.get_sample_dataframe() %}
                <tr>
                    {% for value in record %}
                    <td>{{ value }}</td>
                    {% endfor %}
                </tr>
                {% endfor %}
            </table>
        </div>
    </div>
    <button type="submit" class="btn btn-primary">Submit</button>
</form>

{% endblock %}

{% extends "base.html" %}
{% block content %}

<script>

    $(function () {
        $('[data-toggle="tooltip"]').tooltip()
    });

    $(document).ready(function() {
        $('#spreadsheetTable').DataTable();

        $('.share_spreadsheet').click(function(event) {
            spreadsheet_id = $(event.target).parent().attr('id').split("_")[2];
            $.ajax({
                url: "{{url_for('spreadsheets.share')}}",
                data: JSON.stringify({'spreadsheet_id': spreadsheet_id}),
                dataType: "json",
                contentType: "application/json",
                type: 'POST',
                success: function (response) {
                    url = "{{url_for('spreadsheets.share', _external=True)}}/" + response['share'];
                    $("#share_url").val(url);
                    $('#share_popup').modal()
                },
                error: function (response) {
                    alert(response['errors'])
                }
            });
        });
    });

</script>

<div class="page-header">
    <h1>Saved Spreadsheets</h1>
</div>

{% with messages = get_flashed_messages() %}
    {% if messages %}
        <div class="badge badge-info">Notes</div>
        <div class="server-notes">
            {% for message in messages %}
                <div>{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

{% if errors %}
    <div class="badge badge-danger">Errors</div>
    <div class="server-errors">
        {% for error in errors %}
            <div>{{error}}</div>
        {% endfor %}
    </div>
{% endif %}


{% if user.spreadsheets %}
    <table id="spreadsheetTable" class="table table-striped table-bordered" width="100%">
        <thead>
            <tr>
                <th>Uploaded File</th>
                <th>Date Uploaded</th>
                <th>Name</th>
                <th>Days</th>
                <th>Timepoints</th>
                <th>Breakpoint</th>
                <th>Last Update</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
        {% for spreadsheet in user.spreadsheets %}
            {% if spreadsheet.error %}
                <tr class="alert alert-danger" role="alert">
                    {% else %}
                <tr>
            {% endif %}
                <td>
                    {{spreadsheet.original_filename}}
                    &nbsp;&nbsp;
                    <a href="{{ url_for('spreadsheets.edit_details', spreadsheet_id = spreadsheet.id) }}">
                        <i class="fas fa-edit" data-toggle="tooltip" data-placement="top" title="Edit"></i>
                    </a>
                </td>
                <td data-sort="{{spreadsheet.date_uploaded}}">{{spreadsheet.date_uploaded.strftime("%d%b%Y, %H:%M") }}</td>
                <td>{{spreadsheet.descriptive_name}}</td>
                <td>{{spreadsheet.days}}</td>
                <td>{{spreadsheet.timepoints}}</td>
                <td>{{spreadsheet.breakpoint}}</td>
                <td data-sort="{{spreadsheet.last_access}}">{{spreadsheet.last_access.strftime("%d%b%Y, %H:%M") }}</td>
                <td class="actions">
                    <a href="{{ url_for('spreadsheets.show_spreadsheet', spreadsheet_id = spreadsheet.id) }}">
                        <i class="fas fa-eye" data-toggle="tooltip" data-placement="top" title="View graphs"></i>
                    </a>
                    <a href="{{ url_for('spreadsheets.download', spreadsheet_id = spreadsheet.id) }}"
                       download="processed_file_{{spreadsheet.id}}.txt">
                        <i class="fas fa-download" data-toggle="tooltip" data-placement="top" title="Download"></i>
                    </a>
                    <a id='share_spreadsheet_{{spreadsheet.id}}' class="share_spreadsheet" href="#">
                       <i class="fas fa-share-square" data-toggle="tooltip" data-placement="top" title="Share"></i>
                    </a>
                    <a href="{{ url_for('spreadsheets.delete', spreadsheet_id = spreadsheet.id) }}">
                        <i class="fas fa-trash" data-toggle="tooltip" data-placement="top" title="Delete"></i>
                    </a>
                </td>
            </tr>
        {% endfor %}
        </tbody>
        <!--
        <tfoot>
            <tr>
                <td>Uploaded File</td>
                <td>Date Uploaded</td>
                <td>Name</td>
                <td>Days</td>
                <td>Timepoints</td>
                <td>Breakpoint</td>
                <td>Processed File</td>
                <td>Last Update</td>
                <td> </td>
            </tr>
        </tfoot>
        -->
    </table>
{% endif %}

<div id="share_popup" class="modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">URL to share this spreadsheet</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="share_url">Copy this URL and offer it to anyone with whom you'd like to share your
                    spreadsheet data:</label>
                <textarea id="share_url" class="form-control" rows="5"></textarea>
            </div>
        </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}
{% extends "base.html" %}
{% block content %}

<script>

    $(function () {
        $('[data-toggle="tooltip"]').tooltip()
    });

    $(document).ready(function() {
        var table = $('#spreadsheetTable').DataTable({
                        aoColumnDefs: [
                            { 'bSortable': false, 'aTargets': [ 7 ] },
                            { 'visible': false, 'aTargets': [8] }
                        ],
                        order: [[ 1, 'desc' ]],
                        select: {
                            style: 'multi'
                        }
                    });

        table.on('user-select', function(e, dt, type, cell, originalEvent) {
            var tr = $(originalEvent.target).parent();
            if(!tr.hasClass('text-dark')) {
                e.preventDefault();
            }
        });

        $('.share_spreadsheet').click(function(event) {
            spreadsheet_id = $(event.target).parent().attr('id').split("_")[2];
            $.ajax({
                url: "{{url_for('spreadsheets.share')}}",
                data: JSON.stringify({'spreadsheet_id': spreadsheet_id}),
                dataType: "json",
                contentType: "application/json",
                type: 'POST',
                success: function (response) {
                    url = "{{url_for('spreadsheets.share', _external=True)}}/" + response['share'];
                    $("#share_url").val(url);
                    $('#share_popup').modal()
                },
                error: function (response) {
                    alert(response['errors'])
                }
            });
        });
        $('.delete_spreadsheet').click(function(event) {
            $("#confirm_delete .btn-danger").attr('href', $(this).attr('data-href'));
            $("#confirm_delete").modal();
        });

        $('#compare').click(function(event) {
            var row_data = table.rows( { selected: true } ).data();
            var spreadsheet_list = [];
            $.each($(row_data), function(key, value) {
                spreadsheet_list.push(value[8])
            });
            if(!spreadsheet_list || spreadsheet_list.length != 2) {
                $("#alert-error").modal()
                return
            }

            console.log(spreadsheet_list);
            spreadsheet_ids = spreadsheet_list.join(",");
            compare_url = "{{ url_for('spreadsheets.compare') }}";
            window.location.href = compare_url + "?spreadsheet_ids=" + spreadsheet_ids
        })
    });

</script>

<div class="page-header">
    <h1>Saved Spreadsheets</h1>
</div>

{% with messages = get_flashed_messages() %}
    {% if messages %}
        <div class="badge badge-info">Notes</div>
        <div class="server-notes">
            {% for message in messages %}
                <div>{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
{% endwith %}

{% if errors %}
    <div class="badge badge-danger">Errors</div>
    <div class="server-errors">
        {% for error in errors %}
            <div>{{error}}</div>
        {% endfor %}
    </div>
{% endif %}


{% if user.spreadsheets %}
    <table id="spreadsheetTable" class="table table-striped table-bordered" width="100%">
        <thead>
            <tr>
                <th>Uploaded File</th>
                <th>Date Installed</th>
                <th>Name</th>
                <th>Days</th>
                <th>Time-<br />points</th>
                <th>Break<br />point</th>
                <th>Last Update</th>
                <th>Actions</th>
                <th>IDs</th>
            </tr>
        </thead>
        <tbody>
        {% for spreadsheet in user.spreadsheets %}
            {% if spreadsheet.error %}
                {% set class="alert alert_danger" %}
            {% else %}
                {% set class="text-dark" %}
            {% endif %}
            <tr class={{class}}>
                <td>{{spreadsheet.original_filename}}</td>
                <td data-sort="{{spreadsheet.date_uploaded}}">
                    {{ momentjs(spreadsheet.date_uploaded).format('LLL') }}
                </td>
                <td>{{spreadsheet.descriptive_name}}</td>
                <td>{{spreadsheet.days}}</td>
                <td>{{spreadsheet.timepoints}}</td>
                <td>{{spreadsheet.breakpoint}}</td>
                <td data-sort="{{spreadsheet.last_access}}">
                    {{ momentjs(spreadsheet.last_access).format('LLL') }}
                </td>
                <td class="actions">
                     <a href="{{ url_for('spreadsheets.edit_details', spreadsheet_id = spreadsheet.id) }}">
                        <i class="fas fa-edit" data-toggle="tooltip" data-placement="top" title="Edit"></i>
                    </a>
                    <a href="{{ url_for('spreadsheets.show_spreadsheet', spreadsheet_id = spreadsheet.id) }}">
                        <i class="fas fa-eye" data-toggle="tooltip" data-placement="top" title="View graphs"></i>
                    </a>
                    <a href="{{ url_for('spreadsheets.download', spreadsheet_id = spreadsheet.id) }}"
                       download="processed_file_{{spreadsheet.id}}.txt">
                        <i class="fas fa-download" data-toggle="tooltip" data-placement="top" title="Download"></i>
                    </a>
                    <a id='share_spreadsheet_{{spreadsheet.id}}' class="share_spreadsheet" href="#">
                       <i class="fas fa-share-square" data-toggle="tooltip" data-placement="top" title="Share"></i>
                    </a>
                    <a data-href="{{ url_for('spreadsheets.delete', spreadsheet_id = spreadsheet.id) }}" class="delete_spreadsheet" href="#">
                        <i class="fas fa-trash" data-toggle="tooltip" data-placement="top" title="Delete"></i>
                    </a>
                </td>
                <td>{{spreadsheet.id}}</td>
            </tr>
        {% endfor %}
        </tbody>
        <!--
        <tfoot>
            <tr>
                <td>Uploaded File</td>
                <td>Date Uploaded</td>
                <td>Name</td>
                <td>Days</td>
                <td>Timepoints</td>
                <td>Breakpoint</td>
                <td>Last Update</td>
                <td>Actions</td>
                <td>IDS</td>
            </tr>
        </tfoot>
        -->
    </table>

    <button type="button" class="btn btn-primary" id="compare">Compare</button>
{% endif %}


<div id="share_popup" class="modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">URL to share this spreadsheet</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="share_url">Copy this URL and offer it to anyone with whom you'd like to share your
                    spreadsheet data:</label>
                <textarea id="share_url" class="form-control" rows="5"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
    </div>
  </div>
</div>

<div class="modal fade" id="confirm_delete" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="model-title">Delete Confirmation</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Please confirm deletion...
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">Cancel</span>
                </button>
                <a class="btn btn-danger" href="#">Delete</a>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="alert-error" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="model-title text-danger">Error</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body text-danger">
                Presently, we only support comparing two spreadsheets at a time.  Please adjust your selection
                accordingly.
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">Dismiss</span>
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}
{% extends "base.html" %}
{% block content %}

<script>

    $(function () {
        $('[data-toggle="tooltip"]').tooltip()
    });

    PCA_WIDTH = 800;
    PCA_HEIGHT = 800;
    PCA_SYMBOL = "M 0,-15 A 15,15 0 0,1 15,0 L 0,0 Z M 15,0 A 15,15 0 0,1 -15,0 A 15,15 0 0,1 0,-15 L 0,-10 A 10,10 0 0,0 -10,0 A 10,10 0 0,0 10,0";

    $(document).ready(function () {
        labels = {{ ids | safe }};
        x_values = {{ x_values | safe }};
        x_labels = {{ x_labels | safe }};
        x_label_values = {{ x_label_values | safe }};
        data = {{ data | safe }};
        column_pairs = {{ column_pairs | safe }};
        descriptive_name = '{{ descriptive_name | safe }}'
        breakpoint = {{ breakpoint | safe }};
        qs = {{ qs | safe }};
        ps = {{ ps | safe }};
        tds = {{ tds | safe }};
        amplitudes = {{ amplitudes | safe }};
        anova_ps = {{ anova_ps | safe }};
        anova_qs = {{ anova_qs | safe }};
        peak_times = {{ peak_times | safe }};
        filtered = {{ filtered | safe }};
        filters = {{ filters | safe }};
        timepoints_per_day = {{ timepoints_per_day | safe }};
        spreadsheet_id = {{ spreadsheet_id | safe }};

        // Handles to the error modal on base.html
        nitecap_error = $("#error-modal");
        nitecap_error_message = $("#error-modal-message");

        // Handles to the filter panel features
        apply_filters_button = $('#applyFilters');
        rerun_qvalues_button = $('#rerun_qvalues');
        hide_filtered_checkbox = document.getElementById("hide_filtered");
        filter_list = $('#filter_list');
        add_filter_button = $('#add_filter_button');
        reset_filters_button = $('#reset_filters_button');

        // Handles for the slider
        coarse_slider = $("#coarse_slider");

        // To be loaded later by ajax
        jtk_ps = null;
        jtk_qs = null;

        // Save a copy of the filters that were run last
        ran_filters = filters.slice();

        // List of the number of significant (non-filtered) features that are at or below a given index
        num_significant_below = labels.map(function(x,i) { return i+1;} );

        // Indexes to the order in which we will display the genes
        // default to the order in which they were sent
        sort_order = labels.map(function(x,i) {return i;});

        // Currently selected row from slider
        selected_row = breakpoint;

        y_values = [];
        trace_name = 'Nothing selected';
        marker_settings = {};

        // d3's default color
        var plot_color = Plotly.d3.scale.category10()(0);

        var scatter_plot = document.getElementById('scatter_plot');

        var values = [{
            x: x_values,
            y: x_values.map(function(x) {return 0;}),
            name: trace_name,
            type: 'scatter',
            mode: 'lines+markers',
            marker: marker_settings
        }];

        var layout = {
            xaxis: {
                title: labels[breakpoint],
                ticktext: x_labels,
                tickvals: x_label_values,
                automargin: true
            }
        };

        // This empty plot should be quickly replaced since we trigger a select change event once everything is
        // set up.
        Plotly.newPlot(scatter_plot, values, layout, {showLink: true});

        var redrawPlot = function () {
            var row_index = sort_order[selected_row];

            // Update the Plotly plot of the feature profile
            let raw_y_values = data[row_index];
            if (raw_y_values === undefined) {
                console.log("Could not find the y-values for row " + row_index);
                return;
            }

            // points for the basketweave styel
            var paired_y_values = [];
            for( var i in column_pairs ) {
                paired_y_values.push( raw_y_values[column_pairs[i][0]], raw_y_values[column_pairs[i][1]], null );
            }
            var paired_x_values = [];
            for( var i in column_pairs ) {
                paired_x_values.push( x_values[column_pairs[i][0]], x_values[column_pairs[i][1]], null );
            }

            var stats = rowStatsByTimepoint(raw_y_values, x_values);

            // Default values for the different plot styles to override
            var values = [{
                x: paired_x_values, y: paired_y_values,
                mode: 'lines+markers',
                marker: marker_settings,
                name: labels[row_index],
                type: 'scatter'
            }];
            var layout = {
                hovermode: 'closest',
                title: labels[row_index],
                xaxis: {
                    ticktext: x_labels,
                    tickvals: x_label_values,
                    automargin: true
                }
            };

            // Pick data and styling based off the plot_style_select value
            var plot_style = $('#plot_style_select').val();
            if (plot_style === "basketweave") {
                // Do nothing, basketweave is already the default settings
            } else if (plot_style === "points") {
                values[0].mode = "markers";
                values[0].x = x_values;
                values[0].y = raw_y_values;
            } else if (plot_style === "mean") {
                values[0].mode = "lines";
                values[0].x = stats.means.map( function (x,i) {return i;} ); // Just 0,1,2,3...
                values[0].y = stats.means;
                values[0].name = labels[row_index] + " means";
            } else if (plot_style === "mean_points") {
                values[0].mode = "markers";
                values[0].x = x_values
                values[0].y = raw_y_values;
                values[1] = {
                    x: stats.means.map( function (x,i) {return i;} ), // Just 0,1,2,3...
                    y: stats.means,
                    name: labels[row_index] + " mean",
                    type: "scatter",
                    mode: "lines",
                    'line': {color: plot_color}
                };
                layout["showlegend"] = false;
            } else if (plot_style === "std") {
                values[0].mode = "lines";
                values[0].x = stats.means.map( function (x,i) {return i;} ); // Just 0,1,2,3...
                values[0].y = stats.means;
                values[0].name = labels[row_index] + " means";
                values[0].error_y = {type: 'data', array:stats.stds, visible:true};
            } else if (plot_style === "SEM") {
                values[0].mode = "lines";
                values[0].x = stats.means.map( function (x,i) {return i;} ); // Just 0,1,2,3...
                values[0].y = stats.means;
                values[0].name = labels[row_index] + " means";
                values[0].error_y = {type: 'data', array:stats.sems, visible:true};
            }
            Plotly.react(scatter_plot, values, layout);
        };

        function updateStatsBox() {
            var row_index = sort_order[selected_row];

            $('#significant_items')[0].value = num_significant_below[selected_row];

            // Update the "statistics" card
            $('#p_value').html(toFixed(ps[row_index], 3));
            $('#p_value').prop('title', toString(ps[row_index]));
            $('#q_value').html(toFixed(qs[row_index], 3));
            $('#q_value').prop('title', toString(qs[row_index]));
            $('#amplitude').html(toFixed(amplitudes[row_index], 3));
            $('#amplitude').prop('title', toString(amplitudes[row_index]));
            $('#anova_p').html(toFixed(anova_ps[row_index], 3));
            $('#anova_p').prop('title', toString(anova_ps[row_index]));
            $('#anova_q').html(toFixed(anova_qs[row_index], 3));
            $('#anova_q').prop('title', toString(anova_qs[row_index]));
            $('#peak_time').html(toFixed(peak_times[row_index], 3));
            $('#peak_time').prop('title', toString(peak_times[row_index]));

            if (jtk_ps !== null && jtk_qs !== null) {
                $('#jtk_p').html(toFixed(jtk_ps[row_index], 3));
                $('#jtk_p').prop('title', toString(jtk_ps[row_index]));
                $('#jtk_q').html(toFixed(jtk_qs[row_index], 3));
                $('#jtk_q').prop('title', toString(jtk_qs[row_index]));
            } else {
                $('#jtk_p').html("loading");
                $('#jtk_p').prop('title', "loading");
                $('#jtk_q').html("loading");
                $('#jtk_q').prop('title', "loading");
            }
        }

        $('#plot_style_select').change( function () {
            redrawPlot();
        });

        coarse_slider.slider({
            orientation: "horizontal",
            min: 0,
            value: breakpoint,
            step: 1,
            range: "min",
            max: labels.length - 1,
            slide: function (event, ui) {
                selected_row = ui.value;
                rowSelector.selectRow(selected_row);

                $('#row_selector').focus();
            }
        });

        // Make the row selector
        function onRowSelect(selection) {
            selected_row = selection;

            // Update the coarse slider
            coarse_slider.slider("option", "value", selected_row);

            updateStatsBox();
            redrawPlot();
        }
        var num_row_selections = 21; // Show this many rows at once
        rowSelector = makeRowSelector($('#row_selector')[0],  labels, qs, filtered, sort_order, num_row_selections, onRowSelect);
        rowSelector.selectRow(breakpoint);
        $("#hide_filtered").change( function() {
            sortRows();
        });

        var computeHeatmap = function() {
            $('#heatmap_block').hide();
            $('#download_heatmap').hide();
            $('#heatmap_controls').hide();
            $('#cutoff').html(num_significant_below[selected_row]);

            // Ajax call to save cutoff value
            $.ajax({
                url: "{{ url_for('spreadsheets.save_cutoff') }}",
                data: JSON.stringify({'spreadsheet_id': spreadsheet_id, 'cutoff': selected_row}),
                dataType: "json",
                contentType: "application/json",
                type: 'POST',
                // No response is coming back
                success: function (response) {
                },
                // If an error is returned notify the user.
                error: function (request, status, error) {
                    error_message = $.parseJSON(request.responseText).error;
                    nitecap_error_message.text(error_message);
                    nitecap_error.modal();
                }
            });

            let selected_indexes = sort_order.filter( function(row_num,rank) {
                return (rank <= selected_row) & (!filtered[row_num]);
            });
            var phase_sorted_order = selected_indexes.sort( function (i,j) {
                return compare(peak_times[i], peak_times[j], i,j);
            } );

            var zScoreData = computeZScores(phase_sorted_order)(data);
            var meanZScores = meanByTimepoints(zScoreData, x_values);

            heatmap_data = zScoreData;
            heatmap_combined_data = meanZScores;
            heatmap_labels = phase_sorted_order.map( function(i) {
                return labels[i];
            } );


            var rep_counts = [];
            heatmap_x_values = x_values.map( function(time) {
                if (rep_counts[time] === undefined) {
                    rep_counts[time] = 0;
                }
                rep_counts[time] += 1;
                var day = Math.floor(time / timepoints_per_day) + 1;
                var time_of_day = time % timepoints_per_day + 1;
                return "Day " + day + " Timepoint " + time_of_day + " Rep " + rep_counts[time];
            });

            updateHeatmap();
        };

        var updateHeatmap = function () {
            var heatmap_options = {
                modeBarButtonsToAdd: [{
                    name: 'download in SVG format',
                    icon: Plotly.Icons.camera,
                    click: function (gd) {
                        Plotly.downloadImage(gd, {format: 'svg'})
                    }
                }]
            };


            var x_values;
            var data;
            var combine_replicates = $('#combine_replicates').is(':checked');
            if (combine_replicates) {
                x_values = x_labels;
                data = heatmap_combined_data;
            } else {
                x_values = heatmap_x_values;
                data = heatmap_data;
            }

            // Find max/min values so that we can center the colormap with 0=middle
            var maxRow = data.map(function(row){ return Math.max.apply(Math, row); });
            var minRow = data.map(function(row){ return Math.min.apply(Math, row); });

            var max = Math.max.apply(null, maxRow);
            var min = Math.min.apply(null, minRow);
            var limit = Math.max(Math.abs(min), max);

            var y_vals =  heatmap_labels.map(function (x,i) {return i;});
            var show_labels = $('#heatmap_show_labels').is(':checked');

            var heatmap_values = [{
                x: x_values,
                y: y_vals,
                z: data,
                type: 'heatmap',
                zmin: -1 * limit,
                zmax: limit,
                colorbar: {
                    title: 'Z Scale',
                    titleside: 'right'
                }
            }];

            var heatmap_layout = {
                height: 700,
                width: 900,
                margin: {
                    l: 200,
                    r: 5,
                    b: 175,
                    t: 20
                },
                pad: 4,
                yaxis: {
                    tickmode: "array",
                    ticktext: heatmap_labels,
                    tickvals: y_vals,
                    showticklabels: show_labels,
                    ticks: ''
                }
            };

            Plotly.newPlot('heatmap', heatmap_values, heatmap_layout, heatmap_options);
            $('#heatmap_block').show();
            $('#download_heatmap').show();
            $('#heatmap_controls').show();
        };

        $('#combine_replicates').change(function() {
            updateHeatmap()
        });

        $('#heatmap_show_labels').change(function() {
            updateHeatmap()
        });

        // PCA plot
        function setPCAPointStyles() {
            let pca_plot = Plotly.d3.select("#pca_plot");
            let points = pca_plot.select(".points").selectAll("path");

            // remove any existing background circles
            pca_plot.selectAll(".scatter").selectAll("circle").remove();
            // Add in background circles
            points.each(function(x,i,j) {
                let t = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                t.setAttributeNS(null, "r", "13");
                t.setAttributeNS(null, "transform", this.getAttributeNS(null,"transform"));
                t.setAttributeNS(null, "fill", "white");
                this.parentNode.insertBefore(t, this);
            });

            // Set the shape of the points to be the "colored wedge" shape
            points.attr("d", PCA_SYMBOL);
            // Rotate the colored wedge by the time (x-value)
            points.attr("transform", function(x,i) {
                let rotation = (x_values[i] % timepoints_per_day) / timepoints_per_day * 360 - 45;
                let curr_transform = this.getAttribute("transform");
                if (curr_transform.indexOf("rotate") < 0) {
                    return curr_transform + " rotate(" + rotation + ")";
                } else {
                    return curr_transform;
                }
            });

            setPCALegend();
        }

        function setPCALegend() {
            let pca_plot = Plotly.d3.select('#pca_plot');
            let info_layer = pca_plot.select('.infolayer');

            // Remove any existing legend
            info_layer.selectAll('.pca_legend').remove();
            info_layer.selectAll('.pca_legend_bg').remove();

            let times = x_label_values;
            let labels = x_labels;

            if (times.length > 6) {
                // If there are too many points to show all in the legend
                // then downsample them to be a more reasonable number
                let n = Math.floor(times.length/6);
                times = times.filter( function (x,i) { return (i % n) === 0; });
                labels = labels.filter( function (x,i) { return (i % n) === 0; });
            }

            let margin = 5;
            let entry_height = 30;
            let radius = 15;
            let legend_width = 200;
            let legend_height = (entry_height+margin)*times.length + margin;
            let x = 800;
            let y = 50;

            // Expand the SVG to fit the legend
            pca_plot.selectAll('.main-svg').attr('width', PCA_WIDTH + margin*2 + legend_width);

            // Background rect
            let bg = info_layer.append('rect')
                        .attr('class', 'pca_legend_bg')
                        .attr('x', x + margin)
                        .attr('y', y + margin)
                        .attr('width', legend_width)
                        .attr('height', legend_height)
                        .attr('fill', 'rgb(238,238,238)');

            // Group containing all the entries in the legend, translated to be inside the bg rect
            let g = info_layer.append('g')
                    .attr('class', 'pca_legend')
                    .attr('transform', 'translate(' + (x + 2*margin) + "," + (y + 2*margin) + ")");

            // Each entry is a path (the symbol, appropriately rotated) and text describing the time
            let entries = g.selectAll('g')
                            .data(times)
                           .enter()
                             .append('g')
                             .attr('transform', function (x,i) {return 'translate(0,'+ (i*(entry_height+margin)) + ')';});
            entries.append('path')
                    .attr('transform', function (x,i) {
                            return 'translate(' + radius + ',' + radius + ')'
                                  +'rotate(' + ((times[i] % timepoints_per_day) / timepoints_per_day * 360 - 45) + ')';
                        })
                    .attr('d', PCA_SYMBOL)
                    .attr('fill', 'rgb(127,127,127)');

            entries.append('text')
                    .attr('x',2*radius + margin)
                    .attr('transform', 'translate(0,' + radius + ')')
                    .attr('dy', '0.4em')
                    .text(function (x,i) { return labels[i]; });
        }

        let pca_button = $('#run_pca');
        function runPCA() {
            // We only run PCA on unfiltered genes below the selected row
            var selected_genes = sort_order.filter( function(row,rank) {
                if (rank > selected_row) {
                    return false;
                }
                if (filtered[row]) {
                    return false;
                }
                return true;
            });

            var alert = $('#run_pca_alert');
            if (selected_genes.length <  3) {
                alert.text("Too few rows selected, need at least 3 for PCA.");
                alert.show();
                return;
            } else {
                alert.hide();
            }

            var rep_counts = [];
            var pt_labels = x_values.map( function(time) {
                if (rep_counts[time] === undefined) {
                    rep_counts[time] = 0;
                }
                rep_counts[time] += 1;
                var day = Math.floor(time / timepoints_per_day) + 1;
                var time_of_day = time % timepoints_per_day + 1;
                return "Day " + day + " Timepoint " + time_of_day + " Rep " + rep_counts[time];
            });

            pca_button.prop('disabled', true);
            pca_button.html("<span class='spinner-border spinner-border-sm text-light mr-2' role='status' aria-hidden='true'>" +
                        "</span>Processing...");

            $.ajax({
                url: "{{url_for('spreadsheets.run_pca')}}",
                data: JSON.stringify({'spreadsheet_ids': [spreadsheet_id],
                                      'selected_genes': selected_genes,
                                      'take_logtransform': $('#pca_logtransform').is(':checked'),
                                      'take_zscore': $('#pca_zscore').is(':checked')}),
                dataType: 'json',
                contentType: 'application/json',
                type: 'POST',
                success: function (response) {
                    pca_coords = response['pca_coords'];
                    explained_variance = response['explained_variance'];

                    var traces = [{
                            x: pca_coords[0],
                            y: pca_coords[1],
                            mode: 'markers',
                            name: descriptive_name,
                            text: pt_labels,
                            marker: {
                                size: 25,
                                opacity: 1.0 // x_values.map( function (x) { return (x+1) / (1+Math.max.apply(null, x_values)); } )
                            }
                        }];

                    var layout = {
                        height:PCA_HEIGHT,
                        width:PCA_WIDTH,
                        xaxis: {
                            title: "PC1 (" + toFixed(explained_variance[0]*100,1) + "%)"
                        },
                        yaxis: {
                            title: "PC2 (" + toFixed(explained_variance[1]*100,1) + "%)"
                        },
                        hovermode: 'closest',
                        legend: {
                            x:0,
                            y:1,
                            bgcolor: '#EEEEEE'
                        }
                    };

                    let pca_plot = document.getElementById('pca_plot');
                    Plotly.newPlot(pca_plot, traces, layout);
                    pca_plot.on('plotly_afterplot', setPCAPointStyles);

                    $('#pca_controls').show();
                },
                error: function (error) {
                    console.log("Error running PCA");
                    console.log(error);
                    alert.text(error.responseText);
                    alert.show();
                },
                complete: function() {
                    // Restore PCA button function
                    pca_button.prop('disabled', false);
                    pca_button.html('Run PCA');
                }
            });
        };

        pca_button.click(runPCA);
        $('#pca_zscore').change(function() {
            runPCA();
        });
        $('#pca_logtransform').change(function() {
            runPCA();
        });

        $('#download_pca').click(function() {
            // NOTE: we cannot use Plotly.downloadImage() since we have modified the plot
            // after its creation and the downloadImage() won't reflect those changes
            // So instead we just directly grab its SVG structure by toSVG() and then download that

            // Gather the plot as an SVG
            let pca_plot = document.getElementById('pca_plot');
            let svg_data = Plotly.Snapshot.toSVG(pca_plot, {format: 'svg'});

            // Create a URL for it
            let blob = new Blob([svg_data]);
            let url = URL.createObjectURL(blob);

            // Trigger downloading of the URL by making an <a href ...> to it and clicking it
            var anchor = document.createElement("a");
            anchor.href = url;
            anchor.download = "pca.svg";
            document.body.appendChild(anchor);
            anchor.click();
            document.body.removeChild(anchor);

            // Cleanup after 60s, they've presumably successfully downloaded the small svg
            setTimeout(function () { URL.revokeObjectURL(url) }, 60000);
        });

        let set_cutoff_button = $("#set_breakpoint");
        set_cutoff_button.click(function() {
            set_cutoff_button.prop('disabled', true);
            set_cutoff_button.html(
                "<span class='spinner-border spinner-border-sm text-light mr-2' role='status' aria-hidden='true'>" +
                "</span>Computing...");
            computeHeatmap();
            set_cutoff_button.prop('disabled', false);
            set_cutoff_button.html('Generate Heatmap')
        });

        $('#download_heatmap').click(function() {
            var gd = document.getElementById('heatmap');
            Plotly.downloadImage(gd, {format: 'svg', filename: 'heatmap_' + (selected_row+1)});
        });

        $('#download_plot').click(function() {
            var gd = document.getElementById('scatter_plot');
            Plotly.downloadImage(gd, {format: 'svg', filename: 'plot_' + (selected_row+1)});
        });

        // Configuration of the filters
        let filter_data_list = [
            ["max_value", {values: function () { return maximums(data); },
                            name: "Maximum value",
                            independent: true}],
            ["mean_value", {values: function () { return means(data); },
                            name: "Mean value",
                            independent: true}],
            ["nitecap_p", {values: function () { return ps; },
                            name: "Nitecap p",
                            independent: false}],
            ["nitecap_q", {values: function () { return qs; },
                            name: "Nitecap q",
                            independent: false}],
            ["jtk_p", {values: function () { return jtk_ps; },
                            name: "JTK p",
                            independent: false}],
            ["jtk_q", {values: function () { return jtk_qs; },
                            name: "JTK q",
                            independent: false}],
            ["anova_p", {values: function () { return anova_ps; },
                            name: "ANOVA p",
                            independent: false}],
            ["anova_q", {values: function () { return anova_qs; },
                            name: "ANOVA q",
                            independent: false}],
            ["amplitude", {values: function () { return amplitudes; },
                            name: "Amplitude",
                            independent: false}],
            ["peak_time", {values: function () { return peak_times; },
                            name: "Peak time",
                            independent: false}]
            ];
        // Build a Map for convenience of the filter data
        filter_data = new Map();
        filter_data_list.forEach( function(pair) {
            filter_data.set(pair[0], pair[1]);
        });

        function updateFilterList() {
            // Get raw DOM element, not the jQueried version
            let filter_list_element = filter_list.get(0);

            if (filters.length == 0) {
                // Deafult to empty max-value filter
                filters = [["max_value", NaN, NaN]];
            }

            // Clear out the filter list before remaking it
            while (filter_list_element.lastChild) {
                filter_list_element.removeChild(filter_list_element.lastChild);
            }

            filters.forEach( function (filter, i) {
                // Create the filter entries in the filter list

                let variable = filter[0];
                let lower_bound = filter[1];
                let upper_bound = filter[2];

                let filter_item_row = document.createElement('div');
                filter_item_row.className = "row";

                let filter_item_div = document.createElement('div');
                filter_item_div.className = "col form-inline filter_item";
                filter_item_row.appendChild(filter_item_div);

                let filter_lb = document.createElement('input');
                filter_lb.className = "form-control form-control-sm m-1 filter_lower_bound";
                filter_lb.style="width: 85px";
                if (!isNaN(lower_bound) && lower_bound !== null) {
                    filter_lb.value = '' + lower_bound;
                }
                filter_lb.addEventListener('change', readFilters);
                filter_item_div.appendChild(filter_lb);

                let less_than_symbol = "\u2264"; // Actaully less than or equal to symbol
                filter_item_div.appendChild(document.createTextNode(less_than_symbol));

                let filter_value_selector = document.createElement('select');
                filter_value_selector.className = "form-control form-control-sm m-1 filter_value_selector";
                filter_data.forEach(function (filter, key) {
                    let option = document.createElement('option');
                    option.setAttribute("value", key);
                    option.innerHTML = filter.name;
                    filter_value_selector.appendChild(option);
                });
                filter_value_selector.value = variable;
                filter_item_div.appendChild(filter_value_selector);

                filter_item_div.appendChild(document.createTextNode(less_than_symbol));

                let filter_ub = document.createElement('input');
                filter_ub.className = "form-control form-control-sm m-1 filter_upper_bound";
                filter_ub.style="width: 85px";
                if (!isNaN(upper_bound) && upper_bound !== null) {
                    filter_ub.value = '' + upper_bound;
                }
                filter_ub.addEventListener('change', readFilters);
                filter_item_div.appendChild(filter_ub);

                let remove_button = document.createElement('button');
                remove_button.className = "btn btn-default";
                remove_button.setAttribute('aria-label', 'Remove filter');
                remove_button.setAttribute('title', 'Remove filter');

                function make_listener(index) {
                    return function () {
                        filters = filters.filter(function (x,j) { return j !== index; } );
                        updateFilterList();
                    };
                }
                remove_button.addEventListener('click', make_listener(i));

                let icon  = document.createElement('span');
                icon.className = 'far fa-minus-square';
                remove_button.appendChild(icon);

                filter_item_row.appendChild(remove_button);


                filter_list_element.appendChild(filter_item_row);
            });
        }
        updateFilterList();

        add_filter_button.click( function () {
            filters.push( ['max_value', null, null] );
            updateFilterList();
        });

        reset_filters_button.click( function () {
            filters = ran_filters.slice();
            updateFilterList();
        });

        // Applying Filters
        function applyFilters() {
            // Copy the filters that we last ran
            ran_filters = filters.slice();

            let filtered_out = data.map( function (x) {return false;} );

            // Apply all filters
            filters.forEach(function(filter) {
                var filter_value = filter[0];

                var lower_bound = filter[1];
                var upper_bound = filter[2];

                if (isNaN(lower_bound) || lower_bound === null) {lower_bound = -Infinity;}
                if (isNaN(upper_bound) || upper_bound === null) {upper_bound = Infinity;}

                let values = filter_data.get(filter_value).values();
                filtered_out = filtered_out.map( function (x,i) {
                    return x || (values[i] < lower_bound) || (values[i] > upper_bound);
                });
            });

            filtered = filtered_out;

            if (hide_filtered_checkbox.checked) {
                // Move filtered items from the sort_order to the back of the list  to hide them
                let head = sort_order.filter( function(x) {return !filtered[x];});
                let tail = sort_order.filter( function(x) {return filtered[x];});
                sort_order = head.concat(tail);
            }

            computeNumSignificantBelow();

            // Update row selector display to reflect the new filtering
            rowSelector.filterRows(filtered);
            rowSelector.update();
        }

        function computeNumSignificantBelow() {
            // Recompute the number of signifcant items below a cutoff
            var ctr = 0;
            var set_significant_items = false;
            var significant_items = $('#significant_items')[0];
            $.each(data, function (index, row) {
                if (!filtered[sort_order[index]]) {
                    ctr++;
                }

                num_significant_below[index] = ctr;

                // Update number of significant items
                if (index >= row_index && !set_significant_items) {
                    significant_items.value  = ctr;
                    set_significant_items = true;
                }
            });
        }
        computeNumSignificantBelow();

        function readFilters() {
            // Reads the values from the DOM into the filters list
            filters = filter_list.find(".filter_item").map( function() {
                var filter = $(this);

                var value = filter.find(".filter_value_selector").val();

                var lower_bound = parseFloat(filter.find(".filter_lower_bound").val());
                var upper_bound = parseFloat(filter.find(".filter_upper_bound").val());

                return [[value, lower_bound, upper_bound]];
            }).toArray();
        }

        onApplyFilters = function(rerun_qvalues) {
            // First gather all the filters the user has entered
            readFilters();

            // Apply the filters to the rows
            // and also updates all the appropriate display
            sortRows();

            // Update the DB with the features
            // and if rerunning q-values, ask server to do that
            $.ajax({
                url: "{{url_for('spreadsheets.save_filters')}}",
                data: JSON.stringify({
                    'spreadsheet_id': spreadsheet_id,
                    'filtered_out': filtered,
                    'rerun_qvalues': rerun_qvalues,
                    'filters': JSON.stringify(filters)
                }),
                dataType: "json",
                contentType: "application/json",
                type: 'POST',

                success: function (response) {
                    if (rerun_qvalues) {
                        qs = response["qs"];
                        ps = response["ps"];
                        jtk_qs = response["jtk_qs"];
                        anova_qs = response["anova_qs"];

                        updateRowLabels();
                    }
                    // Do nothing if not rerunning q-values
                },

                // If an error is returned notify the user.
                error: function (request) {
                    error_message = $.parseJSON(request.responseText).error;
                    nitecap_error_message.text(error_message);
                    nitecap_error.modal();
                },

                complete: function () {
                    rerun_qvalues_button.prop('disabled', false);
                    rerun_qvalues_button.html('Rerun q-values');
                }
            });

            if (rerun_qvalues) {
                rerun_qvalues_button.prop('disabled', true);
                rerun_qvalues_button.html(
                    "<span class='spinner-border spinner-border-sm text-light mr-2' role='status' aria-hidden='true'>" +
                    "</span>Computing...");
            }
        };
        apply_filters_button.click( function () {onApplyFilters(false);} );

        rerun_qvalues_button.click( function () {
            // Check if any filters violate assumptions of rerunning the q-values
            let invalid = false;
            filters.forEach( function (filter) {
                if (!filter_data.get(filter[0]).independent) {
                    let has_lb = !(isNaN(filter[1]) || (filter[1] === null));
                    let has_ub = !(isNaN(filter[2]) || (filter[2] === null));
                    if (has_lb || has_ub) {
                        invalid = true;
                    }
                }
            } );

            if (invalid) {
                // Popup a modal to issue the warning before proceeding
                $('#rerun_qvalues_warning').modal();
            } else {
                // All good, apply the filters and rerun-qvalues
                onApplyFilters(true);
            }
        });


        var searchRows = function() {
            var search_value = $('#row_search_box').val().toLowerCase();

            // Pull out row indexes matching our search_value
            var matching_rows = labels.map( function(unused, index) {
                var label = labels[sort_order[index]];
                if (label.toLowerCase().indexOf(search_value) !== -1) {
                    return index;
                }
            }).filter(isFinite);


            if (matching_rows.length === 0) {
                console.log("Unfortunately no matching row found.");
                // TODO: display something to the user
                return;
            }

            // First look for matches that are *after* our selected_row
            // so that multiple button presses will cycle the selection through all matches
            var matches_after = matching_rows.filter( function (i) {
                return i > selected_row;
            } );
            if (matches_after.length > 0) {
                var row = matches_after[0];
            } else {
                // If that fails, grab the first matching row
                var row = matching_rows[0];
            }

            rowSelector.selectRow(row);
        };
        $('#search_button').click( searchRows);
        $('#row_search_box').on("keydown", function (evt) {
            if (evt.keyCode === 13) { // On Enter key press
                searchRows();
            }
        });

        var sorters = {
            "nitecap": function(i,j) {
                var a = tds[i];
                var b = tds[j];
                return compare(a,b,i,j);
            },
            "anova": function (i,j) {
                // Sort anova p-values in ascending order
                var a = anova_ps[i];
                var b = anova_ps[j];
                return compare(a,b,i,j);
            },
            "jtk": function (i,j) {
                // Sort jtk p-values in ascending order
                var a = jtk_ps[i];
                var b = jtk_ps[j];
                return compare(a,b,i,j);
            },
            "amplitude": function (i,j) {
                // Sort jtk p-values in ascending order
                var a = -amplitudes[i];
                var b = -amplitudes[j];
                return compare(a,b,i,j);
            }
        };

        function updateRowLabels() {
            var sorter = $('#sort_select').val();
            if (sorter === 'jtk') {
                rowSelector.makeRowLabels(labels, jtk_qs);
            } else if (sorter === 'anova') {
                rowSelector.makeRowLabels(labels, anova_qs);
            } else {
                rowSelector.makeRowLabels(labels, qs);
            }
        }

        var sortRows = function () {
            var sorter = $('#sort_select').val();
            sort_order = labels.map( function(x,i) {return i;} );
            sort_order = sort_order.sort( sorters[sorter] );

            updateRowLabels();
            applyFilters();

            rowSelector.setSortOrder(sort_order);
            rowSelector.selectRow(selected_row);

        };
        $('#sort_select').change( sortRows );

        $('#significant_items').change( function () {
            let target = Math.round(this.value);
            let row = target-1;
            for(; row < labels.length; row++) {
                if (num_significant_below[row] >= target) {
                    break;
                }
            }

            if (row < 0) {
                row = 0;
            } else if (row > labels.length-1) {
                row = labels.length-1;
            }

            rowSelector.selectRow(row);
        } );


        // Load the JTK values
        $.ajax({
            url: "{{url_for('spreadsheets.get_jtk')}}",
            data: JSON.stringify({'spreadsheet_id': spreadsheet_id}),
            dataType: "json",
            contentType: "application/json",
            type: 'POST',
            success: function(response) {
                jtk_ps = response['jtk_ps'];
                jtk_qs = response['jtk_qs'];

                $('#sort_select option[value="jtk"]').removeAttr("disabled");

                // Display the new values by reselecting the current row
                updateStatsBox();
            },
            error: function(error) {
                console.log("Error loading JTK values");
                console.log(error);
            }
        });

        // Create a share
        $('#share_spreadsheet').click(function() {
            $.ajax({
                url: "{{url_for('spreadsheets.share')}}",
                data: JSON.stringify({'spreadsheet_id': spreadsheet_id, 'row_index': $('#significant_items')[0].value}),
                dataType: "json",
                contentType: "application/json",
                type: 'POST',
                success: function (response) {
                    let url = "{{url_for('spreadsheets.share', _external=True)}}/" + response['share'];
                    $("#share_url").val(url);
                    $('#share_popup').modal()
                },
                error: function (request) {
                    error_message = $.parseJSON(request.responseText).error;
                    nitecap_error_message.text(error_message);
                    nitecap_error.modal();
                }
            })
        });

        let note_popover = $('#annotate');
        note_popover.popover().on('shown.bs.popover', function() {
            $('.btn-annotate').on('click', function() {

                // Locate the note content
                let parentElement = $(this).parent().parent();
                let popoverTextareaElement = parentElement.find('textarea');
                let note = popoverTextareaElement.val();
                $.ajax({
                    url: "{{url_for('spreadsheets.save_note')}}",
                    data: JSON.stringify({"spreadsheet_id": spreadsheet_id, "note": note}),
                        dataType: "json",
                        contentType: "application/json",
                        type: 'POST',
                        success: function () {

                            // Add the new note content to the anchor tag that called the popover so that the
                            // user will see the new content if s/he opens the note for editing again.
                            let new_content = note_popover.attr('data-content')
                                .replace(/>.*<\/textarea/, ">" + note + "</textarea>");
                            note_popover.attr('data-content', new_content);
                        },
                        error: function (request) {
                            let error_message = $.parseJSON(request.responseText).error;
                            nitecap_error_message.text(error_message);
                            nitecap_error.modal();
                        },
                        complete: function(data) {
                            note_popover.popover('hide');
                        }
                    });
                });
                $('.btn-annotate-dismiss').on('click', function() {
                    note_popover.popover('hide');
                });
            });

    });


</script>

<div id="graph-page" class="page-header">
    <h1>Results <small>Data sorted by significance</small></h1>
</div>


<div class="row">
    <p class="col-lg-12 h3">{{descriptive_name}}
        <a href="{{ url_for('spreadsheets.download', spreadsheet_id=spreadsheet_id) }}" class="mx-3" download="processed_file.txt">
            <i class="fas fa-download" data-toggle="tooltip" data-placement="top" title="Download"></i>
        </a>
        <a href="{{ url_for('spreadsheets.collect_data', spreadsheet_id = spreadsheet_id) }}">
            <i class="fas fa-edit" data-toggle="tooltip" data-placement="top" title="Edit"></i>
        </a>
        {% if not visitor %}
        <a id='share_spreadsheet' href="#">
            <i class="fas fa-share-square" data-toggle="tooltip" data-placement="top" title="Share"></i>
        </a>
        {% endif %}
        <a id="annotate" href="#" rel="popover" data-container="body" data-toggle="popover" data-placement="right"
           data-trigger="click" title="Add a Note" data-html=true
           data-content="<div id='spreadsheet_notes' class='annotate_form'>
                            <textarea class='form-control' cols='30' rows='10'>{{ spreadsheet_note or '' }}</textarea>
                            <div class='float-right'>
                                <button class='btn-annotate btn btn-primary'>
                                    <i class='fas fa-check'></i>
                                </button>
                                <button class='btn-annotate-dismiss btn btn-white'>
                                    <i class='fas fa-times'></i>
                                </button>
                            </div>
                        </div>"
        >
            <i class="fas fa-sticky-note" data-toggle="tooltip" data-placement="top" title="Annotate"></i>
        </a>
    </p>
</div>

<div class="row">
    <span class="form-group col-lg-9">
        Number of selected rows:
        <input type="number" id="significant_items"></input>
    </span>
</div>

<div class="row">
    <div class="col">
        <div id="coarse_slider" class="coarse-slider"></div>
    </div>
</div>

<div class="row">
    <p style="margin:auto">Less Significant <i class="fas fa-arrow-right"></i></p>
</div>

<div class='row'>

    <div class='col-auto'>
        <div class='row'>
            <div class="col">
                <div class="input-group mb-2">
                    <input class="form-control form-control-sm" type="text" name="row_search"
                           placeholder="Search for row by label" id="row_search_box" />
                    <div class="input-group-append">
                        <button type="button" id="search_button" class="btn btn-secondary btn-sm">
                            Search
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class='row'>
            <div class='col-auto'>
                <span class="selector-info align-middle"><i class="fas fa-arrow-left"></i> Less Significant</span>
                <div id="row_selector" class="list-group" tabindex="0" style="white-space:pre">
                </div>
                <div class="form-check">
                    <input class="form-check-input" id="hide_filtered" type="checkbox" value="">
                    <label class="form-check-label" for="hide_filtered">Hide filtered rows</label>
                </div>
            </div>
        </div>
    </div>

    <div class='col-auto'>
        <div id="scatter_plot" style="width:625px;height:450px;vertical-align: top"></div>
        <label for="plot_style_select"></label>
        <select id="plot_style_select" class="form-control form-control-sm">
            <option value="basketweave" selected>Basketweave</option>
            <option value="points">Points</option>
            <option value="mean">Mean only</option>
            <option value="mean_points">Points and Mean</option>
            <option value="std">Standard Deviations</option>
            <option value="SEM">SEM</option>
        </select>
        <div class='py-3 float-right'>
            <button id="download_plot" class="btn btn-primary">Download Plot</button>
        </div>
    </div>

    <div class="col-auto">
        <div class="card">
            <div class="card-header">
                Statistics
                <a id="statsHelp" class="text-primary help-pointer"
                   data-container="body" data-toggle="popover" data-placement="top" data-trigger="click"
                   title="Statistics Help"
                   data-content="Displays statistics about the selected row. JTK values are calculated on first page load and may a take a minute.">
                    <i class="fas fa-info-circle ml-3"></i>
                </a>
            </div>
            <div class="card-body">
                <label for="sort_select">Sort by:</label>
                <select id="sort_select" class="form-control form-control-sm">
                    <option value="nitecap">Nitecap</option>
                    <option value="jtk" disabled>JTK</option>
                    <option value="anova">ANOVA</option>
                    <option value="amplitude">Amplitude</option>
                </select>
                <table class="table table-sm">
                    <tbody>
                        <tr> <td rowspan="2">Nitecap
                            <a class="text-primary help-pointer float-right"
                               data-container="body" data-toggle="popover" data-placement="top" data-trigger="click"
                               title="Nitecap"
                               data-content="Nitecap significance of rhythmicity for primary dataset.">
                                <i class="fas fa-info-circle ml-3"></i>
                            </a>
                            </td> <td>p: <span id="p_value"></span></td>
                        </tr>
                        <tr> <td>q: <span id="q_value"></span></td></tr>

                        <tr> <td rowspan="2">JTK
                            <a class="text-primary help-pointer float-right"
                               data-container="body" data-toggle="popover" data-placement="top" data-trigger="click"
                               title="JTK"
                               data-content="JTK_cycle significance of rhythmicity for primary dataset.">
                                <i class="fas fa-info-circle ml-3"></i>
                            </a>
                            </td> <td>p: <span id="jtk_p"></span></td> </tr>
                        <tr> <td>q: <span id="jtk_q"></span></td></tr>

                        <tr> <td rowspan="2"> ANOVA
                            <a class="text-primary help-pointer float-right"
                               data-container="body" data-toggle="popover" data-placement="top" data-trigger="click"
                               title="ANOVA"
                               data-content="1-Way ANOVA on primary dataset. If there are no replicates on timepoints, ANOVA cannot be run.">
                                <i class="fas fa-info-circle ml-3"></i>
                            </a>
                             </td> <td>p: <span id="anova_p"></span></td>
                        </tr>
                        <tr> <td>q: <span id="anova_q"></span></td></tr>

                        <tr> <td>Amplitude
                            <a class="text-primary help-pointer float-right"
                               data-container="body" data-toggle="popover" data-placement="top" data-trigger="click"
                               title="Amplitude"
                               data-content="Amplitude of the variation.">
                                <i class="fas fa-info-circle ml-3"></i>
                            </a>
                            </td>
                            <td id="amplitude"></td>
                        </tr>

                        <tr> <td>Peak-time
                            <a class="text-primary help-pointer float-right"
                               data-container="body" data-toggle="popover" data-placement="top" data-trigger="click"
                               title="Peak-time"
                               data-content="Time the peak value occurs at (the 'acrophase'). The units are the numbers of the timepoints, i.e. 3.5 means half-way between timepoint 3 and timepoint 4.">
                                <i class="fas fa-info-circle ml-3"></i>
                            </a>
                             </td> <td id="peak_time"></td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="row">
        <div id="FiltersCard" class="col-auto">
            <div class="card">
                <div class="card-header">
                    Filters
                    <a id="filtersHelp" class="text-primary help-pointer"
                       data-container="body" data-toggle="popover" data-placement="top" data-trigger="click"
                       title="Filter Help"
                       data-content="Keep only rows matching the criteria provided. Rerunning the q-values computes q-values using only the unfiltered genes. This is statistically invalid to do if filtering on most criteria (eg: if filtering p-values or q-values, one should not rerun the q-values). Instead, only rerun q-values when filtering exclusively on time-unaware criteria (such as max value).">
                        <i class="fas fa-info-circle ml-3"></i>
                    </a>
                </div>
                <div class="card-body">
                    <div class="form-group" id="filter_list">
                        <!-- Filters will go here, made dynamically -->
                    </div>
                    <button id="add_filter_button" class="btn btn-default" aria-label="Add filter">
                        <span class="far fa-plus-square fa-lg" title="Add filter" data-toggle="tooltip" data-placement="top"></span>
                    </button>
                    <button id="reset_filters_button" class="btn btn-default" aria-label="Reset filters">
                        <span class="fas fa-undo fa-lg" title="Reset filters" data-toggle="tooltip" data-placement="top"></span>
                    </button>
                    <div>
                        <button id="applyFilters" type="button" class="btn btn-primary mb-4">Apply filters</button>
                        <button id="rerun_qvalues" type="button" class="btn btn-primary mb-4">Rerun q-values</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<div class="row py-2">
    <span class="col-lg-5">
        <input type="hidden" id="row_index" name="row_index"/>
        <button id="set_breakpoint" class="btn btn-primary">Generate Heatmap</button>
    </span>
</div>

<div class="row">
    <div class="card" id="heatmap_block" style="display:none">
        <div class="card-body">

            <div>
                Number of items in heatmap: <span id="cutoff"></span>
                <div id="heatmap"></div>
            </div>

            <div class="row">
                <div id="heatmap_controls" class="col-lg-6" style="display:none">
                    <span style="vertical-align:center;padding-right:1rem">Combine Replicates</span>
                    <label class="switch">
                        <input id="combine_replicates" name="combine_replicates" type="checkbox" />
                        <span class="slider"></span>
                    </label>

                    <span style="vertical-align:center;padding-right:1rem">Show row labels</span>
                    <label class="switch">
                        <input id="heatmap_show_labels" name="combine_replicates" type="checkbox" />
                        <span class="slider"></span>
                    </label>
                </div>

                <div class='col-lg-6'>
                    <button id="download_heatmap" class="btn btn-primary" style="display:none">Download Heatmap</button>
                </div>

            </div>

        </div>
    </div>
</div>

<div class="row">
    <div class="col card">
        <div class="card-body">
            <button id="run_pca" class="btn btn-primary">Run PCA</button>
            <span id="run_pca_alert" class="alert alert-error"></span>
            <div id="pca_plot"></div>

            <span id="pca_controls" class="col" style="display:none">
                <span>log(x+1) Transform</span>
                <label class="switch">
                    <input id="pca_logtransform" name="pca_logtransform" type="checkbox" />
                    <span class="slider"></span>
                </label>

                <span for="pca_zscore">Z-Score Normalization</span>
                <label class="switch">
                    <input id="pca_zscore" name="pca_zscore" type="checkbox" >
                    <span class="slider"></span>
                </label>

                <button id="download_pca" class="btn btn-primary">Download PCA</button>
            </span>
        </div>
    </div>
</div>

<!-- Modals -->
<div id="share_popup" class="modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header bg-primary">
        <h5 class="modal-title text-white">SHARE this spreadsheet</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span class="text-white" aria-hidden="true">&times;</span>
        </button>
      </div>
        <div class="modal-body">
            <div class="form-group">
                <label for="share_url">Copy this URL and offer it to anyone with whom you'd like to share your
                    spreadsheet data:</label>
                <textarea id="share_url" class="form-control" rows="6"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        </div>
    </div>
  </div>
</div>

<div class="modal" id="rerun_qvalues_warning" tabindex="-1" role="dialog" aria-labelledby="rerun_qvalues_warning_label">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title" id="rerun_qvalues_warning_label">Warning</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>
                    Rerunning q-values with a filter that depends upon the time values is not statistically valid.
                    Use 'Apply Filter' instead to apply the filter without recomputing q-values, or proceed without any guarantees about the correctness of the q-values produced.
                </p>
                <p>
                    Rerunning q-values reduces the number of features being tested for the purpose of multiple-hypothesis testing correction.
                    Doing so is justified only when the criteria for excluding a test is independent of the exogenous variables (for circadian analysis, the times at which each datapoint was collected).
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal" onclick="onApplyFilters(true)">Rerun q-values</button>
                <button type="button" class="btn btn-primary" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

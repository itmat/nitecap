{% extends "base.html" %}
{% block content %}
<script>

    $(document).ready(function () {

        labels = {{ ids | safe }};
        x_values = {{ x_values | safe }};
        x_labels = {{ x_labels | safe }};
        x_label_values = {{ x_label_values | safe }};
        data = {{ data | safe }};
        column_pairs = {{ column_pairs | safe }};
        breakpoint = {{ breakpoint | safe }};

        y_values = [];
        trace_name = 'Nothing selected';
        marker_settings = {size: 12, symbol: 'circle-open', color: '#FF00FF'};

        var scatter_plot = document.getElementById('scatter_plot');

        var values = [{
            x: x_values,
            y: Array(x_values.length).fill(0),
            name: trace_name,
            type: 'scatter',
            mode: 'lines+markers',
            marker: marker_settings
        }];

        var layout = {
            xaxis: {
                title: labels[breakpoint],
                ticktext: x_labels,
                tickvals: x_label_values,
                automargin: true
            }
        };

        // This empty plot should be quickly replaced since we trigger a select change event once everything is
        // set up.
        Plotly.newPlot(scatter_plot, values, layout);

        $("#coarse_slider").slider({
            orientation: "horizontal",
            min: 0,
            value: breakpoint,
            step: 1,
            max: labels.length,
            slide: function (event, ui) {
                //$("#row_selector").val(ui.value);
                $('#significant_items').html(ui.value+1);
                $('#row_selector').val(ui.value).trigger("focus");
                raw_y_values = data[ui.value];
                paired_y_values = [];
                paired_y_values = [];
                for( var i in column_pairs ) {
                    paired_y_values.push( raw_y_values[column_pairs[i][0]], raw_y_values[column_pairs[i][1]], null );
                }
                paired_x_values = [];
                for( var i in column_pairs ) {
                    paired_x_values.push( x_values[column_pairs[i][0]], x_values[column_pairs[i][1]], null );
                }
                $('input[name="row_index"]').val(ui.value);
                values = [{
                    x: paired_x_values, y: paired_y_values,
                    mode: 'lines+markers',
                    marker: marker_settings,
                    name: labels[ui.value],
                    type: 'scatter'
                }];
                var layout = {
                    title: labels[ui.value],
                    xaxis: {
                        ticktext: x_labels,
                        tickvals: x_label_values,
                        automargin: true
                    }
                };
                Plotly.react(scatter_plot, values, layout);
            }
        });

        $('#row_selector').change(function () {
            $("#coarse_slider").slider("option", "value", this.value);
            console.log("Selector changed: " + labels[this.value]);
            raw_y_values = data[this.value];

            paired_y_values = [];
            for( var i in column_pairs ) {
                paired_y_values.push( raw_y_values[column_pairs[i][0]], raw_y_values[column_pairs[i][1]], null );
            }
            paired_x_values = [];
            for( var i in column_pairs ) {
                paired_x_values.push( x_values[column_pairs[i][0]], x_values[column_pairs[i][1]], null );
            }

            console.log(this.value, labels[this.value]);
            $('input[name="row_index"]').val(this.value);
            $('#significant_items').html(parseInt(this.value) + 1);
            console.log("row: " + this.value + ",id: " + labels[this.value]);
            values = [{
                x: paired_x_values, y: paired_y_values,
                mode: 'lines+markers',
                marker: marker_settings,
                name: labels[this.value],
                type: 'scatter'
            }];
            var layout = {
                title: labels[this.value],
                xaxis: {
                    ticktext: x_labels,
                    tickvals: x_label_values,
                    automargin: true
                }
            };
            Plotly.react(scatter_plot, values, layout);
        });

        $.each(labels, function (i, label) {
            $('#row_selector').append($('<option>', {
                value: i,
                text: label
            }));
        });

        $('#row_selector').val(breakpoint).trigger("change");

        $('#set_breakpoint').click(function() {
            $('#heatmap_block').hide();
            row_index = $('#row_index').val();
            console.log("Row index is " + row_index)
            $('#cutoff').html(row_index);
            $.ajax({
                url: "{{url_for('spreadsheets.display_heatmap')}}",
                data: JSON.stringify({'row_index': row_index}),
                dataType: "json",
                contentType: "application/json",
                type: 'POST',
                success: function(response) {

                    var heatmap_layout = {
                        height: 700,
                        width: 900,
                        margin: {
                            l: 200,
                            r: 5,
                            b: 175,
                            t: 20
                        },
                        pad: 4
                    };

                    var heatmap_x_values = response['heatmap_x_values'];
                    var heatmap_labels = response['heatmap_labels'];
                    var heatmap_data = response['heatmap_data'];

                    var heatmap_values = [{
                        x: heatmap_x_values,
                        y: heatmap_labels,
                        z: heatmap_data,
                        type: 'heatmap'
                    }];

                    Plotly.newPlot('heatmap', heatmap_values, heatmap_layout);
                    $('#heatmap_block').show();
                },
                error: function(error) {
                    console.log(error);
                }
            });
        });

});


</script>

<div id="graph-page" class="page-header">
    <h1>Results <small>Data sorted by significance</small></h1>
</div>
<div>
    Number of items equal to or more significant than currently selected:
    <span id="significant_items"></span>
</div>
<div id="spreadsheet-breakpoint-page" class="container">
    <div id="coarse_slider" class="coarse-slider"></div>
    <p style="margin:auto">Less Significant <i class="fas fa-arrow-right"></i></p>
    <div>
        <div class='row'>
            <div class='col-xs-1' style="position:relative">
                <span class="selector-info align-middle"><i class="fas fa-arrow-left"></i> Less Significant</span>
            </div>
            <div class='col-xs-11 ...'>
                <div style="display:inline-block;">
                    <select size="20" name="row_selector" id="row_selector">
                    </select>
                </div>
                <div id="scatter_plot" style="width:700px;height:450px;display:inline-block"></div>
            </div>
        </div>
        <div>
            <input type="hidden" id="row_index" name="row_index"/>
            <button id="set_breakpoint" class="btn btn-primary">Set Significance Cutoff</button>
        </div>
        <div id="heatmap_block" style="display:none">
            <div>Number of items in heatmap: <span id="cutoff"></span></div>
            <div id="heatmap"></div>
        </div>
    </div>
{% endblock %}

{% extends "dashboard.html" %}
{% block dashboard_content %}

    <script>

        $(function () {
            $('[data-toggle="tooltip"]').tooltip()
        });

        $(document).ready(function() {
            let visitorSpreadsheetTableElement = $('#visitorSpreadsheetTable');

            let table = visitorSpreadsheetTableElement.DataTable({
                order: [[ 5, 'desc' ]],
                select: {
                    style: 'multi'
                }
            });

            let nitecap_error = $("#error-modal");
            let nitecap_error_message = $("#error-modal-message");

            let delete_button = $('#delete');
            let confirm_delete_modal = $("#confirm_delete_modal");
            let delete_confirmed_button = $("#delete_confirmed")

            delete_button.click(function() {
                var row_data = table.rows( { selected: true } ).data();
                var spreadsheet_list = [];
                $.each($(row_data), function(key, value) {
                    spreadsheet_list.push(value[0])
                });
                delete_confirmed_button.attr('data-id', spreadsheet_list.join(","));
                confirm_delete_modal.modal();
                console.log(spreadsheet_list)
            });

            // Delete is confirmed - send AJAX call to delete spreadsheet
            delete_confirmed_button.on('click', function() {
                let spreadsheet_list = $(this).attr('data-id').split(",");
                confirm_delete_modal.modal('toggle');
                $.ajax({
                    url: "{{url_for('spreadsheets.delete_visitor_spreadsheets')}}",
                    data: JSON.stringify({"spreadsheet_list": spreadsheet_list}),
                    dataType: "json",
                    contentType: "application/json",
                    type: 'POST',
                    success: function () {
                        // The parameter in draw is needed to keep the user on the current page
                        spreadsheet_list.forEach(function(spreadsheet_id) {
                            table.row("#spreadsheet_" + spreadsheet_id).remove().draw(false);
                        });
                    },
                    error: function (request) {
                        let error_message = $.parseJSON(request.responseText).error;
                        nitecap_error_message.text(error_message);
                        nitecap_error.modal();
                    }
                })
            });
        });
    </script>

    <div class="page-header">
        <h2>Visitor Spreadsheets</h2>
    </div>

    {% with messages = get_flashed_messages() %}
        {% if messages %}
            <div class="badge badge-info">Notes</div>
            <div class="server-notes">
                {% for message in messages %}
                    <div>{{ message }}</div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    {% if errors %}
        <div id="error-indicator" class="badge badge-danger">Errors</div>
        <div class="server-errors">
            {% for error in errors %}
                <div>{{ error }}</div>
            {% endfor %}
        </div>
    {% endif %}


{% if users %}
    <table id="visitorSpreadsheetTable" class="table table-striped table-bordered">
        <thead>
            <tr>
                <th>ID</th>
                <th>Uploaded File</th>
                <th>Date Installed</th>
                <th>Name</th>
                <th>Owner</th>
                <th>Current File<br />Size (MB)</th>
                <th>Last Update</th>
            </tr>
        </thead>
        <tbody>
        {% for user in users %}
            {% for spreadsheet in user.spreadsheets %}
                <tr class="text-dark" id="spreadsheet_{{spreadsheet.id}}">
                    <td>{{spreadsheet.id}}</td>
                    <td>{{spreadsheet.original_filename}}</td>
                    <td data-sort="{{spreadsheet.date_uploaded}}">
                        {{ momentjs(spreadsheet.date_uploaded).format('LLL') }}
                    </td>
                    <td>
                        {{spreadsheet.descriptive_name}}
                    </td>
                    <td>
                        {{ spreadsheet.user.username }}
                    </td>
                    <td>
                        {{ spreadsheet.get_total_diskspace_used() }}
                    </td>
                    <td data-sort="{{spreadsheet.last_access}}">
                        {{ momentjs(spreadsheet.last_access).format('LLL') }}
                    </td>
                </tr>
            {% endfor %}
        {% endfor %}
        </tbody>
        <!--
        <tfoot>
            <tr>
                <td>ID</td>
                <td>Uploaded File</td>
                <td>Date Installed</td>
                <td>Name</td>
                <td>Owner</td>
                <td>Current File Size</td>
                <td>Last Update</td>
            </tr>
        </tfoot>
        -->
    </table>
{% endif %}
    <button type="button" class="btn btn-primary" id="delete">Delete</button>

    <div class="modal fade" id="confirm_delete_modal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header bg-primary">
                    <h5 class="model-title text-white">DELETE Confirmation</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span class="text-white" aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    Please confirm deletion...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">Cancel</span>
                    </button>
                    <a id="delete_confirmed" class="btn btn-primary">
                        <span class="text-white">Delete</span>
                    </a>
                </div>
            </div>
        </div>
    </div>
{%  endblock %}